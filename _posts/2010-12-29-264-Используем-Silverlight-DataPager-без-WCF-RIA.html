---
layout: post
title: "Используем Silverlight DataPager без WCF RIA"
date: 2010-12-29 20:25:47
categories: ru
tags: [Silverlight, XAML, DataGrid, DataPager, Paging]
permalink: ru/blog/show/264
---
<p>Может я как-то не правильно подошел к DataPager, но, как оказалось, заставить его нормально работать без DomainDataService не так уж и просто. Идея у меня была простая, думал найти свойство, вроде ItemCount (оно есть, но только для чтения), туда поставить то количество элементов, которое у меня есть, сделать байдинги на PageSize и PageIndex и все должно быть готово. Но пришлось делать все совершенно по-другому. </p>  <p>Вообще, мне кажется, что такая проблема, наверняка, была не только у меня, ну не всегда и не везде же используется WCF RIA, а использовать пейджинг в списках это уже правило хорошего тона, если знаешь, что список будет расти. Интересно, кто как борется с этой проблемой. А я пока расскажу про свой велосипед.</p>    <p>Решение (если его можно назвать таким) у меня всплыло сразу, подумал о подсовывании ему левой коллекции объектов, вроде </p>  <div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">   <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">     <pre style="background-color: white; margin: 0em">dataPager.Source = Enumerable.Range(1, itemsCount);</pre>
<!--CRLF--></div>
</div>

<p>Тут конечно нужно понимать, что существует проблема, если элементов на сервере, действительно много, то есть itemsCount содержит, например, больше миллиона, то и память у нас будет заниматься достаточно шустро, потому мой способ лучше откинуть, и уже честно реализовывать либо свой DataPager, либо специальную IPagedCollectionView коллекцию. В моем случае, когда речь идет о тысячах, десятках тысяч, решил пока оставить так, хотя в ближайшем будущем переделаем на свою IPagedCollectionView. </p>

<p>В общем, в результате у меня получился такой вот контрол:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> CustomDataPager : DataPager</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> CustomDataPager()</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #008000">// Problems with first binding if source is null or PageIndex is more than -1</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">        SetEmptyCollection();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">readonly</span> DependencyProperty TotalItemsCountProperty =</pre>
<!--CRLF-->

    <pre style="margin: 0em">        DependencyProperty.Register(<span style="color: #006080">&quot;TotalItemsCount&quot;</span>, <span style="color: #0000ff">typeof</span> (<span style="color: #0000ff">int</span>), <span style="color: #0000ff">typeof</span> (CustomDataPager),</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                    <span style="color: #0000ff">new</span> PropertyMetadata(0, TotalItemsCountPropertyChanged));</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">readonly</span> DependencyProperty PageSizeExProperty =</pre>
<!--CRLF-->

    <pre style="margin: 0em">        DependencyProperty.Register(<span style="color: #006080">&quot;PageSizeEx&quot;</span>, <span style="color: #0000ff">typeof</span> (<span style="color: #0000ff">int</span>), <span style="color: #0000ff">typeof</span> (CustomDataPager),</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                    <span style="color: #0000ff">new</span> PropertyMetadata(0, PageSizeExPropertyChanged));</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> TotalItemsCountPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (d <span style="color: #0000ff">is</span> CustomDataPager &amp;&amp; e.NewValue <span style="color: #0000ff">is</span> <span style="color: #0000ff">int</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            var dataPager = d <span style="color: #0000ff">as</span> CustomDataPager;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            var newValue = <span style="color: #0000ff">int</span>.Parse(e.NewValue.ToString());</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">if</span> (dataPager.ItemCount != newValue)</pre>
<!--CRLF-->

    <pre style="margin: 0em">                dataPager.SetCollection(newValue);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> PageSizeExPropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">if</span> (d <span style="color: #0000ff">is</span> CustomDataPager &amp;&amp; e.NewValue <span style="color: #0000ff">is</span> <span style="color: #0000ff">int</span>)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="margin: 0em">            var dataPager = d <span style="color: #0000ff">as</span> CustomDataPager;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            var newValue = <span style="color: #0000ff">int</span>.Parse(e.NewValue.ToString());</pre>
<!--CRLF-->

    <pre style="margin: 0em">            dataPager.PageSize = newValue;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> TotalItemsCount</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> (<span style="color: #0000ff">int</span>) GetValue(TotalItemsCountProperty); }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set { SetValue(TotalItemsCountProperty, <span style="color: #0000ff">value</span>); }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> PageSizeEx</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> (<span style="color: #0000ff">int</span>) GetValue(PageSizeExProperty); }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set { SetValue(PageSizeExProperty, <span style="color: #0000ff">value</span>); }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> SetEmptyCollection()</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        SetCollection(0);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> SetCollection(<span style="color: #0000ff">int</span> itemsCount)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (itemsCount &gt; 0)</pre>
<!--CRLF-->

    <pre style="margin: 0em">            Source = <span style="color: #0000ff">new</span> PagedCollectionView(Enumerable.Range(1, itemsCount));</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">else</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">            Source = <span style="color: #0000ff">new</span> PagedCollectionView(<span style="color: #0000ff">new</span> List&lt;<span style="color: #0000ff">int</span>&gt;());</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Ничего умного. Два DependencyProperty, одно из которых – это количество элементов на сервере, при изменении которого, я подставляю фейковую коллекцию. Второе PageSizeEx – это на самом деле обычный PageSize, мне пришлось сделать дополнительное свойство, потому что c PageSize мой байдинг не работал, не знаю почему. А это свойство имеет очень простое поведении, при изменении выставляет значение в PageSize.</p>

<p>Теперь пример использования. Создадим класс Foo, а так же класс FooService, который будет имитировать загрузку страницы с сервера (с небольшой задержкой и асинхронно):</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> Foo</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> ID { get; set; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Name { get; set; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> FooService</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> GetFooListAsync(<span style="color: #0000ff">int</span> pageIndex, <span style="color: #0000ff">int</span> pageSize, Action&lt;PageCollectionInfo&lt;Foo&gt;&gt; postBack)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        Thread thread = <span style="color: #0000ff">new</span> Thread(() =&gt;</pre>
<!--CRLF-->

    <pre style="margin: 0em">                {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                    List&lt;Foo&gt; list = <span style="color: #0000ff">new</span> List&lt;Foo&gt;();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                    <span style="color: #0000ff">for</span> (<span style="color: #0000ff">int</span> i = pageIndex*pageSize; i &lt; (pageIndex + 1)*pageSize; i++)</pre>
<!--CRLF-->

    <pre style="margin: 0em">                    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                        list.Add(<span style="color: #0000ff">new</span> Foo {ID = i, Name = <span style="color: #0000ff">string</span>.Format(<span style="color: #006080">&quot;Foo {0}&quot;</span>, i)});</pre>
<!--CRLF-->

    <pre style="margin: 0em">                    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">                    Thread.Sleep(1000);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">                    postBack(<span style="color: #0000ff">new</span> PageCollectionInfo&lt;Foo&gt; {ItemsCount = 1000, PageCollection = list});</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                });</pre>
<!--CRLF-->

    <pre style="margin: 0em">        thread.Start();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Реализуем BindingModel:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> MainPageBindingModel : INotifyPropertyChanged</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">readonly</span> List&lt;<span style="color: #0000ff">int</span>&gt; _pageSizes = <span style="color: #0000ff">new</span> List&lt;<span style="color: #0000ff">int</span>&gt; {10, 25, 50, 100};</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">readonly</span> FooService _service;</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">int</span> _pageIndex;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">int</span> _pageSize;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">int</span> _itemsCount;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> List&lt;Foo&gt; _items;</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">bool</span> _isBusy;</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> MainPageBindingModel()</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        _service = <span style="color: #0000ff">new</span> FooService();</pre>
<!--CRLF-->

    <pre style="margin: 0em">        _pageSize = _pageSizes.First();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        LoadItems();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> List&lt;<span style="color: #0000ff">int</span>&gt; PageSizes</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        get { <span style="color: #0000ff">return</span> _pageSizes; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> PageIndex</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> _pageIndex; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set { _pageIndex = <span style="color: #0000ff">value</span>; OnPropertyChanged(<span style="color: #006080">&quot;PageIndex&quot;</span>); LoadItems(); }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> PageSize</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> _pageSize; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set { _pageSize = <span style="color: #0000ff">value</span>; OnPropertyChanged(<span style="color: #006080">&quot;PageSize&quot;</span>); LoadItems(); }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> List&lt;Foo&gt; Items</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> _items; } </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set { _items = <span style="color: #0000ff">value</span>; OnPropertyChanged(<span style="color: #006080">&quot;Items&quot;</span>); }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> ItemsCount</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> _itemsCount; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set { _itemsCount = <span style="color: #0000ff">value</span>; OnPropertyChanged(<span style="color: #006080">&quot;ItemsCount&quot;</span>); }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">bool</span> IsBusy</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> _isBusy; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set { _isBusy = <span style="color: #0000ff">value</span>; OnPropertyChanged(<span style="color: #006080">&quot;IsBusy&quot;</span>); }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> LoadItems()</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">if</span> (!IsBusy)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="margin: 0em">            IsBusy = <span style="color: #0000ff">true</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            var dispatcher = Application.Current.RootVisual.Dispatcher;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            _service.GetFooListAsync(PageIndex, PageSize, (x) =&gt;</pre>
<!--CRLF-->

    <pre style="margin: 0em">                        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                            dispatcher.BeginInvoke(() =&gt;</pre>
<!--CRLF-->

    <pre style="margin: 0em">                                                    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                                        Items = x.PageCollection;</pre>
<!--CRLF-->

    <pre style="margin: 0em">                                                        ItemsCount = x.ItemsCount;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                                        IsBusy = <span style="color: #0000ff">false</span>;</pre>
<!--CRLF-->

    <pre style="margin: 0em">                                                    });</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                        });</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> OnPropertyChanged(<span style="color: #0000ff">string</span> propertyName)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        PropertyChanged(<span style="color: #0000ff">this</span>, <span style="color: #0000ff">new</span> PropertyChangedEventArgs(propertyName));</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">event</span> PropertyChangedEventHandler PropertyChanged = <span style="color: #0000ff">delegate</span> { };</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Тут все тоже очень просто, есть готовые свойства PageIndex, PageSize, которые говорят о том сколько элементов мы хотим видеть на странице, и какую страницу мы видим. PageSizes – это подготовленные размеры страниц, которые пользователь может выставлять. Items и ItemsCount – информация об объектах, первое свойство содержит элементы текущей страницы, а второе информацию о том, сколько всего у нас элементов на сервере. Дальше, XAML разметка:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">&lt;</span><span style="color: #800000">UserControl</span> <span style="color: #ff0000">xmlns:toolkit</span><span style="color: #0000ff">=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation/toolkit&quot;</span>  </pre>
<!--CRLF-->

    <pre style="margin: 0em">             <span style="color: #ff0000">xmlns:sdk</span><span style="color: #0000ff">=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation/sdk&quot;</span>  <span style="color: #ff0000">x:Class</span><span style="color: #0000ff">=&quot;SilverlightDataPager.MainPage&quot;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #ff0000">xmlns</span><span style="color: #0000ff">=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #ff0000">xmlns:x</span><span style="color: #0000ff">=&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #ff0000">xmlns:SilverlightDataPager</span><span style="color: #0000ff">=&quot;clr-namespace:SilverlightDataPager&quot;</span> <span style="color: #ff0000">Width</span><span style="color: #0000ff">=&quot;500&quot;</span> <span style="color: #ff0000">Height</span><span style="color: #0000ff">=&quot;300&quot;</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">Grid</span> <span style="color: #ff0000">x:Name</span><span style="color: #0000ff">=&quot;LayoutRoot&quot;</span> <span style="color: #ff0000">Background</span><span style="color: #0000ff">=&quot;White&quot;</span> <span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">        </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">Grid.RowDefinitions</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">&lt;</span><span style="color: #800000">RowDefinition</span> <span style="color: #ff0000">Height</span><span style="color: #0000ff">=&quot;*&quot;</span><span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">&lt;</span><span style="color: #800000">RowDefinition</span> <span style="color: #ff0000">Height</span><span style="color: #0000ff">=&quot;Auto&quot;</span><span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Grid.RowDefinitions</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        </pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">Grid.ColumnDefinitions</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">&lt;</span><span style="color: #800000">ColumnDefinition</span> <span style="color: #ff0000">Width</span><span style="color: #0000ff">=&quot;Auto&quot;</span> <span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">&lt;</span><span style="color: #800000">ColumnDefinition</span> <span style="color: #ff0000">Width</span><span style="color: #0000ff">=&quot;*&quot;</span> <span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Grid.ColumnDefinitions</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">sdk:DataGrid</span> <span style="color: #ff0000">Grid</span>.<span style="color: #ff0000">ColumnSpan</span><span style="color: #0000ff">=&quot;2&quot;</span> <span style="color: #ff0000">ItemsSource</span><span style="color: #0000ff">=&quot;{Binding Path=Items}&quot;</span> <span style="color: #ff0000">CanUserSortColumns</span><span style="color: #0000ff">=&quot;False&quot;</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">&lt;/</span><span style="color: #800000">sdk:DataGrid</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">StackPanel</span>  <span style="color: #ff0000">Grid</span>.<span style="color: #ff0000">Row</span><span style="color: #0000ff">=&quot;1&quot;</span> <span style="color: #ff0000">Orientation</span><span style="color: #0000ff">=&quot;Horizontal&quot;</span> <span style="color: #ff0000">HorizontalAlignment</span><span style="color: #0000ff">=&quot;Right&quot;</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">&lt;</span><span style="color: #800000">TextBlock</span>  <span style="color: #ff0000">VerticalAlignment</span><span style="color: #0000ff">=&quot;Center&quot;</span><span style="color: #0000ff">&gt;</span>Items at page:<span style="color: #0000ff">&lt;/</span><span style="color: #800000">TextBlock</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">&lt;</span><span style="color: #800000">ComboBox</span> <span style="color: #ff0000">VerticalAlignment</span><span style="color: #0000ff">=&quot;Center&quot;</span> <span style="color: #ff0000">ItemsSource</span><span style="color: #0000ff">=&quot;{Binding Path=PageSizes}&quot;</span> <span style="color: #ff0000">SelectedItem</span><span style="color: #0000ff">=&quot;{Binding Path=PageSize, Mode=TwoWay}&quot;</span><span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            </pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">&lt;/</span><span style="color: #800000">StackPanel</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">SilverlightDataPager:CustomDataPager</span>  <span style="color: #ff0000">Grid</span>.<span style="color: #ff0000">Row</span><span style="color: #0000ff">=&quot;1&quot;</span> <span style="color: #ff0000">Grid</span>.<span style="color: #ff0000">Column</span><span style="color: #0000ff">=&quot;1&quot;</span> <span style="color: #ff0000">DisplayMode</span><span style="color: #0000ff">=&quot;FirstLastPreviousNext&quot;</span> <span style="color: #ff0000">PageSizeEx</span><span style="color: #0000ff">=&quot;{Binding Path=PageSize}&quot;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                        <span style="color: #ff0000">PageIndex</span><span style="color: #0000ff">=&quot;{Binding Path=PageIndex, Mode=TwoWay}&quot;</span> <span style="color: #ff0000">TotalItemsCount</span><span style="color: #0000ff">=&quot;{Binding Path=ItemsCount}&quot;</span> <span style="color: #ff0000">HorizontalAlignment</span><span style="color: #0000ff">=&quot;Right&quot;</span>  <span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">toolkit:BusyIndicator</span> <span style="color: #ff0000">IsBusy</span><span style="color: #0000ff">=&quot;{Binding Path=IsBusy}&quot;</span> <span style="color: #ff0000">Grid</span>.<span style="color: #ff0000">RowSpan</span><span style="color: #0000ff">=&quot;2&quot;</span> <span style="color: #ff0000">Grid</span>.<span style="color: #ff0000">ColumnSpan</span><span style="color: #0000ff">=&quot;2&quot;</span> <span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">        </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Grid</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">UserControl</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF--></div>
</div>

<p>Ну и само приложение:</p>
<object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="500px" height="400px">
		  <param name="source" value="http://outcoldman.com/library/content/03/sldatapager/SilverlightDataPager.xap" />
		  <param name="background" value="white" />
		  <param name="minRuntimeVersion" value="4.0.50826.0" />
		  <param name="autoUpgrade" value="true" />
		  <a href="http://go.microsoft.com/fwlink/?LinkID=149156&amp;v=4.0.50826.0" style="text-decoration:none">
 			  <img src="http://go.microsoft.com/fwlink/?LinkId=161376" alt="Get Microsoft Silverlight" style="border-style:none" />
		  </a>
	    </object>

<p>Это конечно же, уж очень примитивные наброски, но может кому-то поможет.</p>

<p>Весь исходный код можно забрать с моего репозитория на <a href="https://www.assembla.com/code/outcoldman_p/subversion/nodes/BlogProjects/SilverlightDataPager">assembla.com</a>. </p>
