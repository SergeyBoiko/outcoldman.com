---
layout: post
title: "Работа с окнами как в Windows 7 при помощи hotkeys: Win + [Up|Down|Left|Right]"
date: 2009-04-20 19:13:00
categories: ru
tags: [WinForms, WinAPI, VistaKeysExtender]
permalink: ru/blog/show/138
---
<p>Редко пользуешься тем, что пишешь сам. Но вот тот самый редкий случай.
В Windows 7 мне очень понравилась возможность позиционирования окон при помощи сочетаний клавиш:</p>
<ul>
<li>
Win   Left - окно крепиться к левому краю</li>
<li> Win   Right - окно крепиться к правому краю</li>
<li> Win   Up -  окно максимизируется</li>
<li> Win   Bottom -  окно в нормальном состоянии.</li>
</ul>
<p>
Причем крепление окон к правому краю и левому, по-моему, уж очень удобная штука, ведь сколько раз приходилось самому располагать два окна на экране, с возможностью сравнения или перепечатывания...</p>
<p>
<a href="/library/images/01/0000014.png"><img width="640" height="400" border="0" alt="" src="/library/images/01/0000014.png" /></a> </p>
<p>
Windows 7 не хочу использовать в качестве основной ОСь - потому что бета (или CR, главное что не Release), а возможность описанную выше использовать хочу. И вот - не поленился, и написал программку на C#, которая реализует данный функционал в Vista (скорее всего работает и более ранних версиях - просто не проверял). И как оказалось - задача не такая уж и сложная. Пришлось проимпортировать множество WinApi функций, а сама реализация разделилась на две: а) функционал, который перехватывает нажатия необходимых сочетаний клавиш б) позиционирование окон.
</p>
<p>
Первую задачу решил при помощи статьи  <a href="http://eknowledger.spaces.live.com/Blog/cns!F475D4DE444DB1AB!695.entry">Low-Level Keyboard Hook in C #</a>, все что осталось сделать мне - найти возможность узнать когда была нажата клавиша LWin:
</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> IntPtr HookCallback(</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  <span style="color: #0000ff;">int</span> nCode, IntPtr wParam, IntPtr lParam)</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  <span style="color: #0000ff;">if</span> (nCode &gt;= 0 &amp;&amp; wParam == (IntPtr)WAKeysHook.WmKeyDown)</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  {</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">if</span> ((<span style="color: #0000ff;">int</span>)WAKeysHook.GetAsyncKeyState((IntPtr)Keys.LWin) != 0) <span style="color: #008000;">// Left Win Key</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">      Keys key = (Keys) Marshal.ReadInt32(lParam);</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">      <span style="color: #0000ff;">if</span> (key == Keys.Left || key == Keys.Right || key == Keys.Up || key == Keys.Down) <span style="color: #008000;">// Arrows keys</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        SetWindowLocation(key);</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  <span style="color: #0000ff;">return</span> WAKeysHook.CallNextHookEx(WaKeysHook.HookId, nCode, wParam, lParam);</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>
Вторая часть задачи: найти активное окно и установить ему грамотный размер (само собой нужно учитывать, что менять размеры можно только окнам с такой возможностью (WS_SIZEBOX), а так же что некоторые окна имеют максимально разрешенные размеры своего окна, как у cmd.exe):</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> SetWindowLocation(Keys k)</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  <span style="color: #008000;">//Active Window</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  IntPtr window = WAWindows.GetForegroundWindow();</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  <span style="color: #008000;">// Check SIZEBOX Style (Window can sizable)</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  <span style="color: #0000ff;">if</span> (((<span style="color: #0000ff;">int</span>)WAWindows.GetWindowLongPtr(window, WAWindows.GwlStyle) &amp; WAWindows.WsSizebox)</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    == WAWindows.WsSizebox)</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// Show window in normal state (if always maximized)</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    WAWindows.ShowWindow(window, (<span style="color: #0000ff;">int</span>)WAWindows.WindowShowStyle.ShowNormal);</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">//Need Maximazed</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">if</span> (k != Keys.Down)</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">      WAWindows.ShowWindow(window, (<span style="color: #0000ff;">int</span>)WAWindows.WindowShowStyle.ShowMaximized);</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">      <span style="color: #008000;">// Place Window on left or right</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">      <span style="color: #0000ff;">if</span> (k != Keys.Up)</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">      {</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        WAWindows.Rect rect, rectDesktop;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">if</span> (WAWindows.GetWindowRect(window, <span style="color: #0000ff;">out</span> rect) &amp;&amp; WAWindows.GetWindowRect(WAWindows.GetDesktopWindow(), <span style="color: #0000ff;">out</span> rectDesktop))</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">          WAWindows.SetWindowPos(window, WAWindows.HwndTop, (k == Keys.Left) ? Math.Min(rect.Left, 0) : rectDesktop.Right / 2, </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                rect.Top, Math.Min(rect.Width, rectDesktop.Right / 2 - Math.Min(rect.Left, 0)),</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                 Math.Min(rect.Height, rectDesktop.Bottom), WAWindows.SwpShowwindow);</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">      }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>
И последнее, в своей программе я ввел возможность установки - необходимо ли отображать значек в трее или нет, который помогает в закрытии программы, для этого нужно установить значение в соответствующей секции app.config.</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">applicationSettings</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">VistaKeysExtender.Properties.Settings</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">setting</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="ShowNotifyIcon"</span> <span style="color: #ff0000;">serializeAs</span><span style="color: #0000ff;">="String"</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">value</span><span style="color: #0000ff;">&gt;</span>False<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">value</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">setting</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">  <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">VistaKeysExtender.Properties.Settings</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">applicationSettings</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>
Мне просто сам значек не нужен, программа крутиться всегда в фоне, а место в трее итак переполнено. Функциональные клавиши я описал вверху статьи. Вопросы и предложения готов выслушать и ответить на них. Надеюсь, что кому то будет так же полезна данная программа как и мне.</p>

<ul><li><a href="http://cid-ed105c18939cfcb7.skydrive.live.com/self.aspx/LiveJournal/VistaKeysExtender.zip">Keys Extender (Win 7 Compatible) - binary</a></li><li><a href="http://cid-ed105c18939cfcb7.skydrive.live.com/self.aspx/LiveJournal/VistaKeysExtender|_x64.zip">Keys Extender (Win 7 Compatible) - binary (x64)</a></li><li><a href="http://cid-ed105c18939cfcb7.skydrive.live.com/self.aspx/LiveJournal/VistaKeysExtender|_source.zip">Keys Extender (Win 7 Compatible) - source</a></li><li><a href="http://www.codeproject.com/KB/cs/KeysExtender.aspx">Article on CodeProject (EN)</a></li></ul>
