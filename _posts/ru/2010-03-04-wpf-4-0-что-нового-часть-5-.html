---
layout: post
title: "WPF 4.0. Что нового? Часть 5."
date: 2010-03-04 13:04:00
categories: ru
tags: [.NET, .NET 4.0, WPF, WPF 4, Visual Studio 2010]
alias: ru/blog/show/189
---
<p>Последняя статья из серии что нового в WPF. Предыдущие версии: 
<a href="/ru/blog/show/168">1</a>, <a href="/ru/blog/show/169">2</a>, <a href="/ru/blog/show/170">3</a>, <a href="/ru/blog/show/188">4</a>. В данной части будет небольшая солянка из еще найденных и откопанных нововведений. Предполагаю, что можно найти и другие, но уже и эти не совсем нужны в продакшене, потому, пожалуй, пора остановится.</p>  <h1>Xbap – Full Trust</h1>  <p>В более ранних версиях, если вы попытаетесь установить Full Trust Xbap, то увидите ошибку “Trust not Granted”. Решений было несколько, одно из которых было – подпись приложения сертификатом и установка сертификата в локальное хранилище пользователя, но тут терялась прелесть технологии ClickOnce. Теперь же пользователю будет предложен диалог выбора – запускать приложение или нет.</p>  <h1>Updated File Dialogs</h1>  <p>В предыдущих версиях окна выбора файлов, директорий и т.п. выглядели в стиле WinXP, теперь же окна полностью соответствуют ОС, в которой запущено приложение, а точнее диалоги выбора файлов в Windows 7 выглядят как в Windows 7. </p>  <h1>Key\Gesture Binding</h1>  <p>Появилась возможность биндить Key и Modifiers в KeyBinding. Теперь можно создать свою DelegateCommand со свойствами </p>  

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">public</span> Key GestureKey { get; set; }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">public</span> ModifierKeys GestureModifier { get; set; }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">public</span> MouseAction MouseGesture { get; set; }</pre><!--CRLF--></div></div>

<p>Инициализировать команду следующим образом</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">public</span> ICommand ExitCommand</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    get</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">if</span> (exitCommand == <span style="color: #0000ff;">null</span>)</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            exitCommand = <span style="color: #0000ff;">new</span> DelegateCommand(Exit);</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            exitCommand.GestureKey = Key.X;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            exitCommand.GestureModifier = ModifierKeys.Control;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            exitCommand.MouseGesture = MouseAction.LeftDoubleClick;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">return</span> exitCommand;    </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>А дальше забиндить клавиши:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Window.InputBindings</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">KeyBinding</span> <span style="color: #ff0000;">Command</span><span style="color: #0000ff;">="{Binding ExitCommand}"</span> <span style="color: #ff0000;">Key</span><span style="color: #0000ff;">="{Binding ExitCommand.GestureKey}"</span> <span style="color: #ff0000;">Modifiers</span><span style="color: #0000ff;">="{Binding ExitCommand.GestureModifier}"</span><span style="color: #0000ff;">/&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Window.InputBindings</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>Без необходимости объявления ресурсов.</p>

<h1>Script Interop in Xbap</h1>

<p>Полезная функциональность для тех, кто встраивает Xbap в свои веб-странички. Кстати, а такие люди вообще бывают? Вообще, конечно, ситуация очень редкая, чтобы xbap хостился внутри html страницы, но все же возможная для приложений внутри локальной сети.</p>

<p>В случае, если у нас на странице будет объявлена javascript функция ReportDate:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">function ReportDate(dateTime) {</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    date = <span style="color: #0000ff;">new</span> Date(dateTime);</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    var dateBox = document.getElementById(<span style="color: #006080;">"displayDate"</span>);</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    dateBox.<span style="color: #0000ff;">value</span> = date.getFullYear();</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>То теперь при помощи класса BrowserInteropHelper мы сможем вызвать ее из нашего xbap приложения очень просто:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">dynamic script = BrowserInteropHelper.HostScript;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">script.ReportDate(DateTime.Now);</pre><!--CRLF--></div></div>

<p>Полноценный пример можно скачать и разобрать здесь - <a href="http://blogs.msdn.com/llobo/archive/2009/11/03/new-wpf-features-script-interop-in-xbap.aspx">New WPF Features: Script Interop in Xbap</a></p>

<h1>XAML: Node Loop flexibility</h1>

<p>Как известно в .NET 4 появилась отдельная библиотека System.Xaml, позволяющая нам обрабатывать Xaml разметку, считывать и превращать в граф объектов. Раньше у нас была возможность так же работать с Xaml разметкой при помощи XamlReader и XamlWriter, но все что они нам давали – это считывать и записывать Xaml, но не предоставляли нам возможность работать с ним. Теперь же набор классов для работы с Xaml пополнился, например, XamlXmlReader, который позволяет пробегаться еще и по элементам xaml дерева. Пример можно посмотреть здесь - <a href="http://blogs.msdn.com/llobo/archive/2009/11/09/xaml-2009-features-node-loop-flexibility.aspx">Node Loop flexibility</a>, в данном примере у считываемого Xaml файла заменяют родительский элемент Window на Page.</p>
<p>
<a rev="vote-for" href="http://progg.ru/outcoldman-WPF-40-%D0%A7%D1%82%D0%BE-%D0%BD%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE-%D0%A7%D0%B0%D1%81%D1%82%D1%8C-5"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.livejournal.com%2F51238.html" style="border:0px"/></a>
</p>
