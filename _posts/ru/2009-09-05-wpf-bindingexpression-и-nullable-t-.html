---
layout: post
title: "WPF: BindingExpression и Nullable<T>"
date: 2009-09-05 08:26:00
categories: ru
tags: [.NET, C#, WPF, XAML, Binding, Nullable]
alias: ru/blog/show/156
---
<p>Если прописывать <strong>Path</strong> в <strong>Binding</strong> на типы <strong>Nullable&lt;T&gt;</strong> на свойство <strong>HasValue</strong>, такие как <em><strong>int?</strong></em>, <em><strong>bool?</strong></em> и другие, то можно увидеть неожиданные результаты, а точнее работать данный биндинг не будет. Давайте рассмотрим данный случай подробнее.</p> <lj-cut>  <p>Итак, предположим в нашем коде присутствует следующая модель данных:</p> 

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">using</span> System; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">namespace</span> WpfApplicationHasValue </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{ </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">class</span> SampleModel </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    { </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">public</span> SampleModel() </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        { </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">         SampleValue2 = 0; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        } </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span>? SampleValue { get; set; } </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span>? SampleValue2 { get; set; } </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    } </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>Получается, что <strong>SampleValue</strong> равен <strong>null</strong> и <strong><em>SampleValue.HasValue</em></strong> возвращает <strong>false</strong>. Используем данную модель в <strong>WPF</strong> приложении:</p> 

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Window</span> <span style="color: #ff0000;">x:Class</span><span style="color: #0000ff;">="WpfApplicationHasValue.MainWindow"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #ff0000;">xmlns:x</span><span style="color: #0000ff;">="http://schemas.microsoft.com/winfx/2006/xaml"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #ff0000;">xmlns:WpfApplicationHasValue</span><span style="color: #0000ff;">="clr-namespace:WpfApplicationHasValue"</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #ff0000;">Title</span><span style="color: #0000ff;">="MainWindow"</span> <span style="color: #ff0000;">Height</span><span style="color: #0000ff;">="240"</span> <span style="color: #ff0000;">Width</span><span style="color: #0000ff;">="500"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #ff0000;">DataContext</span><span style="color: #0000ff;">="{DynamicResource ResourceKey=SampleModel}"</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Window.Resources</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">BooleanToVisibilityConverter</span> <span style="color: #ff0000;">x:Key</span><span style="color: #0000ff;">="BooleanToVisibilityConverter"</span> <span style="color: #0000ff;">/&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">WpfApplicationHasValue:SampleModel</span> <span style="color: #ff0000;">x:Key</span><span style="color: #0000ff;">="SampleModel"</span> <span style="color: #0000ff;">/&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Window.Resources</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">StackPanel</span> <span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextBlock</span> <span style="color: #ff0000;">Visibility</span><span style="color: #0000ff;">="{Binding Path=SampleValue.HasValue, Converter={StaticResource ResourceKey=BooleanToVisibilityConverter}}"</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                Must be InVisible</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">TextBlock</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextBlock</span> <span style="color: #ff0000;">Visibility</span><span style="color: #0000ff;">="{Binding Path=SampleValue2.HasValue, Converter={StaticResource ResourceKey=BooleanToVisibilityConverter}}"</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                Must be Visible</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">TextBlock</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">StackPanel</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Window</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>
<p>На размещенных двух <strong>TextBlock</strong>’ах мы повесили <strong>Binding</strong> на свойства <strong>Visiblility</strong> с конвертером из <strong>bool</strong> в <strong>Visibility</strong>. Конечно мы ожидаем, как я и написал в телах <strong>TextBlock</strong> такого результата, что первый должен быть не видимым, но такого не произойдет, вместо этого в <em>Output</em> окне мы увидим:</p>  <blockquote>   <p><em>System.Windows.Data Error: 40 : BindingExpression path error: 'HasValue' property not found on 'object' ''Int32' (HashCode=0)'. BindingExpression:Path=SampleValue2.HasValue; DataItem='SampleModel' (HashCode=6257078); target element is 'TextBlock' (Name=''); target property is 'Visibility' (type 'Visibility')</em></p> </blockquote>  <p>Проблема конечно же в разборе самого <strong>Path</strong> нашего <strong>Binding</strong>, и очевидно, что сам <strong>WPF</strong> тут не причем. Разбор данного пути будет проходить в два этапа:</p>  <p>1. Получаем <strong>PropertyInfo</strong> для свойства “<em>SampleValue</em>” и вызываем <strong><em>pi.GetValue(item)</em></strong> для получения значения <strong>x</strong>.     <br />2. Получаем <strong>PropertyInfo</strong> для свойства “<em>HasValue</em>” и вызываем <strong><em>pi.GetValue(x)</em></strong> для получения финального результата.</p>  <p>Ну и проблема, собственно, в том, что несмотря на то, что <strong>pi</strong> в первом шаге имеет <em><strong>PropertyType = typeof(Nullable&lt;int&gt;)</strong></em> как и следовало ожидать, величина <strong>x</strong> возвращаемая методом <strong>GetValue</strong> возвращается или <strong>int</strong> или <strong>null</strong>, но не <strong>Nullable&lt;int&gt;.</strong> Следовательно шаг 2 не удается, поскольку <strong>x</strong> не имеет свойство “<em>HasValue</em>”.</p>  <p>В итоге, <strong>WPF</strong> не может поддерживать свойства <strong>HasValue</strong> (или <strong>Value</strong>) в пути биндига, пока <strong>CLR</strong> (<strong>Reflection</strong>) не изменит логику в отношении возвращаемых значений типов <strong><em>Nullable&lt;T&gt;</em></strong>, а такого, скорее всего, не будет. </p>  <p>Само собой, это не является проблемой, и если даже и возникнет такая ситуация, то решить ее можно легко. В основном, данный топик просто для предоставления некоторых основ <strong>WPF</strong>.</p> <p> <a rev="vote-for" href="http://progg.ru/outcoldman-WPF-BindingExpression-%D0%B8-Nullable"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.livejournal.com%2F37153.html" style="border:0px" /></a></p>
