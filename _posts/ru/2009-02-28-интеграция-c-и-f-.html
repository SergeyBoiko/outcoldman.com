---
layout: post
title: "Интеграция C# и F#"
date: 2009-02-28 10:06:00
categories: ru
tags: [WinForms, .NET, C#, F#]
alias: ru/blog/show/126
---
<p>Перед использованием F# задаешься вопросом, а можно ли использовать функции F# в приложениях, написанных на C#.</p> 

<p>Ознакомиться с функциональным языком F# можно, к примеру, по этому адресу: <a href="http://msdn.microsoft.com/ru-ru/magazine/cc164244.aspx" rel="nofollow" >http://msdn.microsoft.com/ru-ru/magazine/cc164244.aspx</a></p>
 
<p>Но вот, по моему мнению, F# как функциональный язык хорош для написания различных математических функций (извиняюсь за тавтологию), но зачем отбирать хлеб у объектно-ориентированных языков, зачем городить непонятный код для работы с WinForms контролами или WebForms страницами на F#? Потому я сразу же задался вопросом, как вызывать функции из F# сборок. Сразу хочу сказать, что так как в функциональных языках есть сложности с типизациями при написании кода, то в случае использования F# функций из сборок C# эти трудности только увеличиваются. Приступим к делу.</p>
 
<p>Создаем проект, который включает в себя, к примеру, C# консольное приложение и сборку F#.</p>
 
<p>В сборке F# нам нужен один файл MyFunctions.fs. Там мы описываем некоторые функции, которые по нашему мнению нам проще написать на функциональном языке. К примеру, пускай это будет функция перевода массива битовой картинки из цветового пространства RGB в YCbCr (это просто пример). Запись в F# может быть примерно такая: </p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;">
  <div id="codeSnippet" >
    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">open System</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #008000;">// Перевод в цветовое пространство YCbCr</span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">let RGB_to_YCbCr (r : <span style="color: #0000ff;">double</span>,g : <span style="color: #0000ff;">double</span>,b : <span style="color: #0000ff;">double</span>) = </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    let y = 0.299 * r + 0.587 * g + 0.114 * b <span style="color: #0000ff;">in</span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    let Cb = (-0.1687) * r - 0.3313 * g + 0.5 * b + 128.0 <span style="color: #0000ff;">in</span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    let Cr = 0.5 * r - 0.4187 * g - 0.0813 * b + 128.0 <span style="color: #0000ff;">in</span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    (y,Cb,Cr);</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">   </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">let RGB_to_YCbCr_v (v : _ array) = </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    RGB_to_YCbCr (v.[0], v.[1], v.[2]);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">let Process (image : _ array)  = </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    let lenght = Array.length image <span style="color: #0000ff;">in</span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    let imageYCbCr = Array.create lenght (0.0, 0.0, 0.0) <span style="color: #0000ff;">in</span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">for</span> index = 0 to lenght - 1 <span style="color: #0000ff;">do</span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        imageYCbCr.[index] &amp;lt;- RGB_to_YCbCr_v (image.[index])</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    done</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    imageYCbCr</pre>
<!--CRLF--></div>
</div> 
<p>После сборки мы можем заметить, что добраться до функций не просто, namespace имеют непонятный вид, и как их использовать тоже не представляется ясным. Посмотреть расположение функций в сборке мы можем при помощи Reflector.</p>
 
<p>Для того, чтобы описать namespace и класс необходимо добавить следующую строку сразу после #light: </p>
 <code>module FSharp.Sample.MyFunctions</code> 
<p>Которая говорит, о том что все функции написанные ниже будут содержаться в классе MyFunctions пространства имен FSharp.Sample.</p>
 
<p>Собрав проект еще раз, мы увидим, что в сборке есть четкий namespace  FSharp.Sample, который имеет класс MyFunctions со статическими методами, которые мы описали выше.</p>
 
<p>Дальше в нашем консольном приложении мы устанавливаем Reference на сборки <em>FSharp.Sample</em> - имя моей сборки на F#, и <em>FSharp.Core</em> - для того, чтобы использовать типы (классы) F# типа Triple. И пишем следующий код:</p>

 <div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;">
  <div id="codeSnippet" >
    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">using</span> System;</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">using</span> FSharp.Sample;</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">namespace</span> CSharp.Sample.Console</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">class</span> Program</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> Main()</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        {</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">double</span>[][] image = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">double</span>[1000][];</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            Random rand = <span style="color: #0000ff;">new</span> Random();</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &amp;lt; 1000; i ++ )</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            {</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                image[i] = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">double</span>[3];</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                image[i][0] = rand.Next();</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                image[i][1] = rand.Next();</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                image[i][2] = rand.Next();</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            }</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">foreach</span> (var doubles <span style="color: #0000ff;">in</span> MyFunctions.Process(image))</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                System.Console.WriteLine(doubles);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            } </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        }</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre>
<!--CRLF--></div>
</div>
<p>Где изначально мы указываем на использование namespace FSharp.Sample. В коде мы генерируем массив данных и передаем его в функцию MyFunction.Process, которая преобразовывает нам его по выбранному алгоритму. Данные нам возвращаются в виде массива данных типов "Microsoft.FSharp.Core.Tuple`3".</p>
