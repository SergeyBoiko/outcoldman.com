---
layout: post
title: "Метод расширение для безопасного приведения типов"
date: 2010-03-25 19:33:00
categories: ru
tags: [.NET, C#, Parse, Convert, Extension Methods]
alias: ru/blog/show/195
---
<p>В добавление к записи <a href="http://nesteruk.wordpress.com/2010/03/22/extension-method-patterns/">Дмитрия Нестерука - Паттерны методов расширения</a> хотел бы добавить еще один метод расширение “Приведение типов”, без которого мне уже сложно обходиться. Автор идеи этого подхода работает сейчас в фирме, где я работал раньше.</p>

<p>Нам часто приходится писать, примерно, такой код:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; font-size: normal; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">int</span> intValue;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">if</span> (obj == <span style="color: #0000ff">null</span> || !<span style="color: #0000ff">int</span>.TryParse(obj.ToString(), <span style="color: #0000ff">out</span> intValue))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    intValue = 0;</pre>
<!--CRLF--></div>
</div>

<p>Это способ безопасного приведения к типу int. Напрашивается сразу же какой либо унифицированный метод для безопасного приведения типов.</p>

<p>Мне нравится подход вынесения преобразования в extension method и использовать его затем следующим образом:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; font-size: normal; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">int</span> i;</pre>
<!--CRLF-->

    <pre style="margin: 0em">i = <span style="color: #006080">&quot;1&quot;</span>.To&lt;<span style="color: #0000ff">int</span>&gt;();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">// i == 1</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">i = <span style="color: #006080">&quot;1a&quot;</span>.To&lt;<span style="color: #0000ff">int</span>&gt;();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">// i == 0 (default value of int)</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">i = <span style="color: #006080">&quot;1a&quot;</span>.To(10);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">// i == 10 (set as default value 10)</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">i = <span style="color: #006080">&quot;1&quot;</span>.To(10);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">// i == 1</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #008000">// ********** Nullable sample **************</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">int</span>? j;</pre>
<!--CRLF-->

    <pre style="margin: 0em">j = <span style="color: #006080">&quot;1&quot;</span>.To&lt;<span style="color: #0000ff">int</span>?&gt;();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">// j == 1</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">j = <span style="color: #006080">&quot;1a&quot;</span>.To&lt;<span style="color: #0000ff">int</span>?&gt;();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">// j == null</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">j = <span style="color: #006080">&quot;1a&quot;</span>.To&lt;<span style="color: #0000ff">int</span>?&gt;(10);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">// j == 10</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">j = <span style="color: #006080">&quot;1&quot;</span>.To&lt;<span style="color: #0000ff">int</span>?&gt;(10);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">// j == 1</span></pre>
<!--CRLF--></div>
</div>

<p>И соответственно реализация данного подхода:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; font-size: normal; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">class</span> Parser</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #008000">/// &lt;summary&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #008000">/// Try cast &lt;paramref name=&quot;obj&quot;/&gt; value to type &lt;typeparamref name=&quot;T&quot;/&gt;,</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #008000">/// if can't will return default(&lt;typeparamref name=&quot;T&quot;/&gt;)</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #008000">/// &lt;/summary&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #008000">/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #008000">/// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #008000">/// &lt;returns&gt;&lt;/returns&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> T To&lt;T&gt;(<span style="color: #0000ff">this</span> <span style="color: #0000ff">object</span> obj)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">return</span> To(obj, <span style="color: #0000ff">default</span>(T));</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #008000">/// &lt;summary&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #008000">/// Try cast &lt;paramref name=&quot;obj&quot;/&gt; value to type &lt;typeparamref name=&quot;T&quot;/&gt;,</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #008000">/// if can't will return &lt;paramref name=&quot;defaultValue&quot;/&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #008000">/// &lt;/summary&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #008000">/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #008000">/// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #008000">/// &lt;param name=&quot;defaultValue&quot;&gt;&lt;/param&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #008000">/// &lt;returns&gt;&lt;/returns&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> T To&lt;T&gt;(<span style="color: #0000ff">this</span> <span style="color: #0000ff">object</span> obj, T defaultValue)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (obj == <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">return</span> defaultValue;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">if</span> (obj <span style="color: #0000ff">is</span> T)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">return</span> (T) obj;</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        Type type = <span style="color: #0000ff">typeof</span> (T);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #008000">// Place convert to reference types here</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span>(<span style="color: #0000ff">string</span>))</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">return</span> (T)(<span style="color: #0000ff">object</span>)obj.ToString();</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        Type underlyingType = Nullable.GetUnderlyingType(type);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (underlyingType != <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">return</span> To(obj, defaultValue, underlyingType);</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">return</span> To(obj, defaultValue, type);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> T To&lt;T&gt;(<span style="color: #0000ff">object</span> obj, T defaultValue, Type type)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #008000">// Place convert to sructures types here</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span>(<span style="color: #0000ff">int</span>))</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">int</span> intValue;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">if</span> (<span style="color: #0000ff">int</span>.TryParse(obj.ToString(), <span style="color: #0000ff">out</span> intValue))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                <span style="color: #0000ff">return</span> (T)(<span style="color: #0000ff">object</span>)intValue;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">return</span> defaultValue;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span>(<span style="color: #0000ff">long</span>))</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">long</span> intValue;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">if</span> (<span style="color: #0000ff">long</span>.TryParse(obj.ToString(), <span style="color: #0000ff">out</span> intValue))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                <span style="color: #0000ff">return</span> (T)(<span style="color: #0000ff">object</span>)intValue;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">return</span> defaultValue;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span>(<span style="color: #0000ff">bool</span>))</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">bool</span> bValue;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">if</span> (<span style="color: #0000ff">bool</span>.TryParse(obj.ToString(), <span style="color: #0000ff">out</span> bValue))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                <span style="color: #0000ff">return</span> (T)(<span style="color: #0000ff">object</span>)bValue;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">return</span> defaultValue;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (type.IsEnum)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">if</span> (Enum.IsDefined(type, obj))</pre>
<!--CRLF-->

    <pre style="margin: 0em">                <span style="color: #0000ff">return</span> (T)Enum.Parse(type, obj.ToString());</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">return</span> defaultValue;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> NotSupportedException(<span style="color: #0000ff">string</span>.Format(<span style="color: #006080">&quot;Couldn't parse to Type {0}&quot;</span>, <span style="color: #0000ff">typeof</span>(T)));</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>


<p>Данный метод не полон – это уже моя собственная реализация данного подхода, которую я использую внутри своего сайта. Он умеет работать с int, long, bool, string, enums (и с Nullable типами этих типов), но, думаю, по ходу работы вам не составит труда дополнять данный парсер необходимыми типами (главное не забывайте про культуры при необходимости).</p>

<p>Очевидно, что данный подход хорошо использовать только внутри знающих что делает данный метод разработчиков, так как не совсем очевидно, почему этот метод не может преобразовать любой тип A к типу B.</p>

<p><a rev="vote-for" href="http://progg.ru/outcoldman-%D0%9C%D0%B5%D1%82%D0%BE%D0%B4-%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%B5%D0%B7%D0%BE%D0%BF%D0%B0%D1%81%D0%BD%D0%BE%D0%B3%D0%BE-%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D1%8F-%D1%82%D0%B8%D0%BF%D0%BE%D0%B2"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.ru%2Fru%2Fblog%2Fshow%2F195" style="border:0px"/></a></p>
