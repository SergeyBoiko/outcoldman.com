---
layout: post
title: "WPF – MenuItem и важное свойство CommandTarget"
date: 2009-08-05 21:12:00
categories: ru
tags: [.NET, C#, WPF, XAML]
alias: ru/blog/show/148
---
<p>Предположим перед вами стоит простая задача – сделать Toolbar контрол, который будет отображаться на каждой странице и он так же будет состоять из меню. Один из вариантов – это разместить все необходимое на UserControl и размещать данный контор на каждом окне. </p> 

<p>В нашем случае UserControl – это Toolbar с меню:</p>  


<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">UserControl</span> <span style="color: #ff0000;">x:Class</span><span style="color: #0000ff;">="WpfApplicationMenuSample.MainUserControl"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #ff0000;">xmlns:x</span><span style="color: #0000ff;">="http://schemas.microsoft.com/winfx/2006/xaml"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">             <span style="color: #ff0000;">x:Name</span><span style="color: #0000ff;">="_this"</span> <span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">UserControl.Resources</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RoutedCommand</span> <span style="color: #ff0000;">x:Key</span><span style="color: #0000ff;">="MenuCommand"</span> <span style="color: #0000ff;">/&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">UserControl.Resources</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">UserControl.CommandBindings</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">CommandBinding</span> <span style="color: #ff0000;">Command</span><span style="color: #0000ff;">="{StaticResource ResourceKey=MenuCommand}"</span>  </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                        <span style="color: #ff0000;">Executed</span><span style="color: #0000ff;">="MenuCommand_Executed"</span>  </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                        <span style="color: #ff0000;">CanExecute</span><span style="color: #0000ff;">="MenuCommand_CanExecute"</span><span style="color: #0000ff;">/&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">UserControl.CommandBindings</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ToolBar</span> <span style="color: #ff0000;">HorizontalAlignment</span><span style="color: #0000ff;">="Stretch"</span> <span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Menu</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">MenuItem</span> <span style="color: #ff0000;">Header</span><span style="color: #0000ff;">="Menu1"</span> <span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">MenuItem</span> <span style="color: #ff0000;">CommandParameter</span><span style="color: #0000ff;">="Menu11"</span>  </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                          <span style="color: #ff0000;">Command</span><span style="color: #0000ff;">="{StaticResource ResourceKey=MenuCommand}"</span>  </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                          <span style="color: #ff0000;">Header</span><span style="color: #0000ff;">="Menu11"</span> <span style="color: #0000ff;">/&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">MenuItem</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">MenuItem</span> <span style="color: #ff0000;">Header</span><span style="color: #0000ff;">="Menu2"</span> <span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">MenuItem</span> <span style="color: #ff0000;">CommandParameter</span><span style="color: #0000ff;">="Menu21"</span>  </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                          <span style="color: #ff0000;">Command</span><span style="color: #0000ff;">="{StaticResource ResourceKey=MenuCommand}"</span>  </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                          <span style="color: #ff0000;">Header</span><span style="color: #0000ff;">="Menu21"</span> <span style="color: #0000ff;">/&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">MenuItem</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Menu</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">ToolBar</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">UserControl</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>В данном примере меню состоит из двух подменю, на которые привешена команда MenuCommand, методы команды простейшие:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> MenuCommand_Executed(<span style="color: #0000ff;">object</span> sender, ExecutedRoutedEventArgs e) </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{ </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    MessageBox.Show(e.Parameter.ToString()); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">} </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> MenuCommand_CanExecute(<span style="color: #0000ff;">object</span> sender, CanExecuteRoutedEventArgs e) </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{ </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    e.CanExecute = <span style="color: #0000ff;">true</span>; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>То есть MenuCommand_CanExecute – гарантирует нам, что вызвать данное меню можно всегда, а MenuCommand_Executed – просто выполняет небольшую логику, просто для примера. </p>

<p>Следующие действие: кладем данный контрол на главное окно приложения:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Window</span> <span style="color: #ff0000;">x:Class</span><span style="color: #0000ff;">="WpfApplicationMenuSample.MainWindow"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #ff0000;">xmlns:x</span><span style="color: #0000ff;">="http://schemas.microsoft.com/winfx/2006/xaml"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #ff0000;">xmlns:WpfApplicationMenuSample</span><span style="color: #0000ff;">="clr-namespace:WpfApplicationMenuSample"</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #ff0000;">Title</span><span style="color: #0000ff;">="Sample"</span> <span style="color: #ff0000;">Height</span><span style="color: #0000ff;">="150"</span> <span style="color: #ff0000;">Width</span><span style="color: #0000ff;">="300"</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">DockPanel</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">WpfApplicationMenuSample:MainUserControl</span> <span style="color: #ff0000;">DockPanel</span>.<span style="color: #ff0000;">Dock</span><span style="color: #0000ff;">="Top"</span><span style="color: #0000ff;">/&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">DockPanel</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextBox</span> <span style="color: #ff0000;">DockPanel</span>.<span style="color: #ff0000;">Dock</span><span style="color: #0000ff;">="Top"</span><span style="color: #0000ff;">/&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Button</span> <span style="color: #0000ff;">&gt;</span>Click<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Button</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">DockPanel</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">DockPanel</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Window</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>Итак, в окне мы разместили наш MainUserControl, а так же поле для ввода и кнопку для примера. После запуска мы видим, что все работает, до того момента, пока мы не перевели фокус в TextBox или не нажали на кнопку Click, после этого мы видим, что MenuItem стали неактивными:</p>  

<p><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Untitled" border="0" alt="Untitled" src="/library/images/01/0000038.png" width="298" height="147" /> </p>  

<p>Догадаться, почему пункты меню стали не активными – сложно, но можно. Нужно обратить внимание на свойство <a href="http://msdn.microsoft.com/ru-ru/library/system.windows.controls.menuitem.commandtarget.aspx">MenuItem.CommandTarget</a>:</p> 

<p><em>Свойство CommandTarget указывает элемент, где исполняется команда. Если CommandTarget не задано, команду получает элемент, на котором находится фокус клавиатуры. </em></p>  <p>А так как фокус находится на элементе TextBox, то вот и получается, что команда выполниться не может. Вообще какая-то странная логика. И, самое интересное, если разместить все то, что находится на UserControl в окно и там же описаться команду и биндинги команды, то все будет работать нормально. </p>  <p>А решить проблему можно указав CommandTarget (заметим, что UserControl имеет имя _this):</p>  

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">MenuItem</span> <span style="color: #ff0000;">CommandParameter</span><span style="color: #0000ff;">="Menu11"</span> <span style="color: #ff0000;">CommandTarget</span><span style="color: #0000ff;">="{Binding ElementName=_this}"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">          <span style="color: #ff0000;">Command</span><span style="color: #0000ff;">="{StaticResource ResourceKey=MenuCommand}"</span>  </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">          <span style="color: #ff0000;">Header</span><span style="color: #0000ff;">="Menu11"</span> <span style="color: #0000ff;">/&gt;</span></pre><!--CRLF--></div></div>

  <p>После этого все будет работать.</p>  
  
  <h4>Скачать пример  <a href="/library/content/01/WpfApplicationMenuSample.zip">WpfApplicationMenuSample.zip</a> (VS 2010).</h4> 
  <p>
<a rev="vote-for" href="http://progg.ru/outcoldman-WPF-MenuItem-%D0%B8-%D0%B2%D0%B0%D0%B6%D0%BD%D0%BE%D0%B5-%D1%81%D0%B2%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE-CommandTarget"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.livejournal.com%2F29072.html" style="border:0px" /></a>
</p>
