---
layout: post
title: "Silverlight: небольшой, но неприятный баг с сортировкой в DataGrid"
date: 2010-11-29 12:51:00
categories: ru
tags: [Silverlight, DataGrid, Bug]
alias: ru/blog/show/257
---
<p>Неделю назад напоролся на баг в Silverlight, точнее в DataGrid контроле, а он пришел, вроде, с Toolkit. Потребовалось больше часа, чтобы понять в чем проблема. </p>  <p>Мы в приложении для части администрирования используем свои контролы, которые могут по схемы таблицы базы данных построить контролы списка объектов и форму для редактирования объектов. Более того, даже строятся join’ы. Сделано это для того, чтобы быстро в административную часть нашего решения быстро добавлять настройки только поменяв метаданные на интерфейсе, не трогая сервисы, и любые другие слои нашего приложения. Пользователям мы эти интерфейсы не показываем, а работаем чаще всего с ними только мы-разработчики и немного наши консультанты и менеджеры, так что внешний вид там не важен. </p>    <p>Все данные объекта содержатся в словаре, и если описать по-простому структуру наших объектов, с которыми мы работаем в административной части, то она, примерно, следующая:</p>  <div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">   <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">     <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> Entity</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    private readonly <span style="color: #0000ff">Dictionary</span>&lt;string, <span style="color: #0000ff">object</span>&gt; _properties = <span style="color: #0000ff">new</span> <span style="color: #0000ff">Dictionary</span>&lt;string, <span style="color: #0000ff">object</span>&gt;();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> Entity(<span style="color: #0000ff">Dictionary</span>&lt;string, <span style="color: #0000ff">object</span>&gt; <span style="color: #0000ff">values</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        _properties = <span style="color: #0000ff">values</span>;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> string this[string <span style="color: #0000ff">column</span>]</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">get</span> { <span style="color: #0000ff">return</span> (_properties[<span style="color: #0000ff">column</span>] ?? string.Empty).ToString(); }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Это уж очень примерно. Понятно, что у нас там есть куча валидации, методов работы с метаданными, подстановка дефолтных значений для вновь созданных объектов и т.п. Но принцип такой, есть индексируемое свойство по строке, к которому осуществляется байдинг.</p>

<p>Обрисую тестовую ViewModel:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> TestViewModel</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> TestViewModel()</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        Collection = <span style="color: #0000ff">new</span> ObservableCollection&lt;Entity&gt;();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">for</span> (<span style="color: #0000ff">int</span> i = 0; i &lt; 5; i++)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            Collection.<span style="color: #0000ff">Add</span>(<span style="color: #0000ff">new</span> Entity(<span style="color: #0000ff">new</span> <span style="color: #0000ff">Dictionary</span>&lt;string, <span style="color: #0000ff">object</span>&gt;()</pre>
<!--CRLF-->

    <pre style="margin: 0em">                                          {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                              {&quot;Person.Name&quot;,      &quot;<span style="color: #0000ff">User</span> &quot; + i}, </pre>
<!--CRLF-->

    <pre style="margin: 0em">                                              {&quot;Person.PersonID&quot;,  i          }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                          }));</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> ObservableCollection&lt;Entity&gt; Collection { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Тут все просто, коллекция с 5-ю элементами. Ключи для коллекции у меня называют так, потому что они строятся из имен таблицы и имени колонки. </p>

<p>Дальше накидаем простую форму с одним элементом DataGrid:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">&lt;</span><span style="color: #800000">UserControl.DataContext</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">SilverlightApplication1:TestViewModel</span> <span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">UserControl.DataContext</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">&lt;</span><span style="color: #800000">Controls:DataGrid</span> <span style="color: #ff0000">x:Name</span><span style="color: #0000ff">=&quot;LayoutRoot&quot;</span>  <span style="color: #ff0000">ItemsSource</span><span style="color: #0000ff">=&quot;{Binding Collection}&quot;</span> <span style="color: #ff0000">AutoGenerateColumns</span><span style="color: #0000ff">=&quot;False&quot;</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">Controls:DataGrid.Columns</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">Controls:DataGridTextColumn</span> <span style="color: #ff0000">Binding</span><span style="color: #0000ff">=&quot;{Binding [Person.PersonID]}&quot;</span> <span style="color: #ff0000">CanUserSort</span><span style="color: #0000ff">=&quot;True&quot;</span> <span style="color: #ff0000">Header</span><span style="color: #0000ff">=&quot;ID&quot;</span> <span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">&lt;</span><span style="color: #800000">Controls:DataGridTextColumn</span> <span style="color: #ff0000">Binding</span><span style="color: #0000ff">=&quot;{Binding [Person.Name]}&quot;</span> <span style="color: #ff0000">CanUserSort</span><span style="color: #0000ff">=&quot;True&quot;</span> <span style="color: #ff0000">Header</span><span style="color: #0000ff">=&quot;Name&quot;</span> <span style="color: #0000ff">/&gt;</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Controls:DataGrid.Columns</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">Controls:DataGrid</span><span style="color: #0000ff">&gt;</span></pre>
<!--CRLF--></div>
</div>

<p>На этапе создания контрола, который работал с нашим динамическим объектом я не добавил поддержку сортировки. Просто объектов было не очень много, да и не нужно было, забыл. Недавно менеджеры попросили добавить сортировку. Я прикинул, что в простом случае, когда все элементы подгружаются за раз, сделать сортировку очень просто, нужно всего добавить CanUserSort к колонкам и все. Задачу оценили в час (вместе с тестированием и развертыванием). </p>

<p>Добавил, чтобы при создании колонок выставлялось true в свойство CanUserSort, а не работает сортировка. И тут началось, я начал пересматривать весь код, пытаясь осознать в чем же проблема, как ее можно побороть. В Output, вообще, ничего не выводилось, что может какой-то байдинг не верно установлен или еще чего.&#160; </p>

<p>Попробовал создать новый проект, в котором все было, примерно, так как показал выше. И все работало! Тут до меня дошло в чем может быть проблема. В ново созданном проекте я использовал в качестве имен колонок простые “PersonID”, “Name”, вместо “Person.PersonID”, “Person.Name”. Видимо ребята, кто писал DataGrid сначала пытаются создать путь, по которому нужно осуществлять поиск объекта, а только потом задумываются о том, что поля могут быть еще и с индексами. Попытался посмотреть в исходниках, но кода у DataGrid контрола слишком много. Свою проблему решил заменой для байдинга точек на символ ‘@’, ну и в свойстве-индексе меняю обратно этот символ на точки, чтобы получить верное значение. </p>

<p>Проверял, в WPF все работает отлично. В общем, <a href="https://connect.microsoft.com/VisualStudio/feedback/details/619684/sorting-doesnt-work-at-datagrid-control-when-column-has-binding-on-indexing-property-with-string-index-which-has-dots" target="_blank">создал баг на connect</a>. Бага не критичная, но в целом складывает не очень хорошее впечатление о качестве контролов в Silverlight.</p>
