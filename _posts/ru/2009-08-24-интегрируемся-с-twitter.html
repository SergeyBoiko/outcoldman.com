---
layout: post
title: "Интегрируемся с Twitter"
date: 2009-08-24 21:12:00
categories: ru
tags: [.NET, C#, Linq2Twitter, Twitter, Windows Service]
alias: ru/blog/show/155
---
<p>Давайте сначала обозначим, что такое Twitter.</p>  <p><strong>Twitter</strong> &ndash; это бесплатный интернет-сервис, представляющий собой систему <a href="http://ru.wikipedia.org/wiki/%D0%9C%D0%B8%D0%BA%D1%80%D0%BE%D0%B1%D0%BB%D0%BE%D0%B3%D0%B3%D0%B8%D0%BD%D0%B3"><strong>микроблогов</strong></a>, позволяющий пользователям отправлять короткие текстовые заметки (до 140 символов), используя веб-интерфейс, <a href="http://ru.wikipedia.org/wiki/SMS">SMS</a>, <a href="http://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D1%8B_%D0%BC%D0%B3%D0%BD%D0%BE%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D0%B3%D0%BE_%D0%BE%D0%B1%D0%BC%D0%B5%D0%BD%D0%B0_%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F%D0%BC%D0%B8">службы мгновенных сообщений</a> или сторонние программы-клиенты (<a href="http://ru.wikipedia.org" title="http://ru.wikipedia.org">http://ru.wikipedia.org</a>).</p>  <p>Второй вопрос, а зачем он нужен вообще? Просто общаться с друзьями? Это как вариант, но все таки существуют более удобные сервисы для обмена сообщениями. Скорее всего для публикацией и слежением за новостями (как личные, так и публичные).</p>  <p>Итак, если у вас есть некий интернет магазин, или сайт компании, на котором вы публикуете новости, то можно создать и twitter аккаунт, для того, чтобы дублировать туда информацию о выходе новых публикаций на сайте (как новости, так и поступление новой продукции), или вы можете прикрутить к своему блогу возможность публиковать в твиттере информацию о поступлении новых топиков (есть готовые сервисы, как <a href="http://twittsync.com/">http://twittsync.com/</a>, работает на Microsoft Azure). Так же можно использовать твиттер &ldquo;не по назначению&rdquo; &ndash; вы можете создать некий пустой аккаунт, который будет публиковать, к примеру, состояние вашего компьютера, через Direct Message на ваш аккаунт или просто к себе на главную &ndash; один из примеров: ваш провайдер требует деньги за белый IP адрес, в противном случае он назначает вам адрес динамически, и каждые 24 часа вас отрубает (это для тех, кто использует роутеры) и вы хотите в любое время (например, с работы) узнавать какой у вас IP адрес для того чтобы зайти на свой домашний компьютер удаленно.</p>  <p>Следующий вопрос, сложно ли это сделать?</p>  <p>Легко! Можно пойти немного по более сложному пути и изучать TwitterAPI самому, тогда вам ни от чего не нужно будет зависеть, для начала тогда нужно воспользоваться статьей &ndash; <a href="http://www.michaelckennedy.net/blog/2009/08/07/ArticleBuildingaTwitterApplicationinNET.aspx">Michael C. Kennedy &ndash; Building a Twitter Application in .NET</a>, путь попроще &ndash; использовать готовое решение <a href="http://linqtotwitter.codeplex.com/">LINQ to Twitter</a> (я им и воспользуюсь).</p>   <p>Итак, давайте начнем с простейшего примера. Создадим консольное приложение со следующим кодом:</p>  

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">using</span> System; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">using</span> System.Linq; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">using</span> LinqToTwitter; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">namespace</span> TwitterIntegration </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{ </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">internal</span> <span style="color: #0000ff;">class</span> Program </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    { </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> Main() </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        { </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">// Класс, отвечающий за авторизацию </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            UsernamePasswordAuthorization auth = <span style="color: #0000ff;">new</span> UsernamePasswordAuthorization </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                                                     { </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                                                         UserName = <span style="color: #006080;">"UserName"</span>, </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                                                         Password = <span style="color: #006080;">"Password"</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                                                     }; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">// Основной провайдер для работы с twitter </span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            TwitterContext twitterCtx = <span style="color: #0000ff;">new</span> TwitterContext(auth); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">// Осуществляем авторизацию </span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            auth.SignOn(); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">// Берем twit'ы, оставленные нашими друзьями (за кем мы следуем) </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            var publicTweets = </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                from tweet <span style="color: #0000ff;">in</span> twitterCtx.Status </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                <span style="color: #0000ff;">where</span> tweet.Type == StatusType.Friends </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                select tweet; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">// Печатаем результат на экран </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            publicTweets.ToList().ForEach( </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                tweet =&gt; Console.WriteLine( </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                             <span style="color: #006080;">"User Name: {0}, Tweet: {1}"</span>, tweet.User.Name, tweet.Text)); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            auth.SignOff(); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            Console.WriteLine(<span style="color: #006080;">"Press any key to end this demo."</span>); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            Console.ReadKey(); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        } </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    } </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>Неправда ли все получается очень просто (не забудьте заменить в вашем случае пользователя и пароль). Причем <strong>TwitterContext</strong> может так же легко работать и с <a href="http://jtweeter.com" title="http://jtweeter.com">http://jtweeter.com</a> и <a href="http://identi.ca" title="http://identi.ca">http://identi.ca</a> (такими же сайтами для микроблогов).</p>  <p>Но давайте вернемся к нашему сценарию. Мы задумали публиковать наш IP адрес. Первый вопрос &ndash; как узнать IP адрес нашего компьютера, для этого можно обратиться к статье <a href="http://www.geekpedia.com/tutorial149_Get-the-IP-address-in-a-Windows-application.html">Get the IP address in a Windows application</a> на <a href="http://www.geekpedia.com">geekpedia</a> &ndash; воспользуемся последним способом (который использует сервис <a href="http://www.geekpedia.com/ip.php" title="http://www.geekpedia.com/ip.php">http://www.geekpedia.com/ip.php</a>), так как этот способ учитывает так же то, что ваш компьютер может быть направлен через роутер (как у меня):</p>  

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">string</span> GetIpAddress() </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{ </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    WebClient myWebClient = <span style="color: #0000ff;">new</span> WebClient(); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    Stream myStream = myWebClient.OpenRead(<span style="color: #006080;">"http://www.geekpedia.com/ip.php"</span>); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    StreamReader myStreamReader = <span style="color: #0000ff;">new</span> StreamReader(myStream); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">return</span> myStreamReader.ReadToEnd(); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>В данному методе используются классы из именованных пространств System.IO и System.Net (не забудьте подключить using&rsquo;и). Создаем новый проект &ndash; <a href="http://msdn.microsoft.com/en-us/library/y817hyb6%28VS.80%29.aspx">Windows Service</a>, добавим в него сразу информацию об установке (<a href="http://msdn.microsoft.com/en-us/library/ddhy0byf%28VS.80%29.aspx">How to: Add Installers to Your Service Application</a>). Воспользуемся классом <a href="http://msdn.microsoft.com/en-us/library/system.timers.timer.aspx">Timer</a> (из System.Timers), который будет каждые 60 минут вызывать метод, который и будет публиковать IP адрес:</p> 

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> TwittIpAddress(<span style="color: #0000ff;">object</span> sender, ElapsedEventArgs e) </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{ </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    UsernamePasswordAuthorization auth = <span style="color: #0000ff;">new</span> UsernamePasswordAuthorization </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                                             { </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                                                 UserName = <span style="color: #006080;">"UserName"</span>, </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                                                 Password = <span style="color: #006080;">"Password"</span> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                                             }; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// Основной провайдер для работы с twitter </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    TwitterContext twitterCtx = <span style="color: #0000ff;">new</span> TwitterContext(auth); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// Осуществляем авторизацию </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    auth.SignOn(); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">string</span> message = <span style="color: #0000ff;">string</span>.Format(<span style="color: #006080;">"My IP Address is: {0}"</span>, GetIpAddress()); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">//Пишем новый tweet </span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    twitterCtx.UpdateStatus(message); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">//Отправляем сообщение на аккаунт </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    twitterCtx.NewDirectMessage(<span style="color: #006080;">"ToUserName"</span>, message); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    auth.SignOff(); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>В данном методе мы сначала обновляем статус аккаунта UserName, а так же отправляем сообщение пользователю ToUserName. Чтобы установить Windows Service воспользуйтесь утилитой <a href="http://msdn.microsoft.com/ru-ru/library/50614e95.aspx">InstallUtil</a>.</p>  <p>Как видите интегрировать свое приложение или веб-сайт с модным Twitter&rsquo;ом очень просто. Более того, таким способом можно повышать свои шансы во всяческих конкурсах, вроде <a href="http://outcoldman.livejournal.com/32610.html">розыгрыша</a> приглашений в офис Google (а похожих розыгрышей бывает много). Пример приложения можно скачать ниже.</p>  <h4>Скачать пример: <a href="/library/content/01/TwitterIntegration.zip">TwitterIntegration.zip</a></p> <p><a rev="vote-for" href="http://progg.ru/outcoldman-%D0%98%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B8%D1%80%D1%83%D0%B5%D0%BC%D1%81%D1%8F-%D1%81-Twitter"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.livejournal.com%2F34574.html" style="border:0px" /></a></p>
