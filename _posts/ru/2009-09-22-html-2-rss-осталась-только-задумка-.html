---
layout: post
title: "Html 2 Rss – осталась только задумка…"
date: 2009-09-22 08:47:00
categories: ru
tags: [XML, HTML2RSS, LiveJournal, Masterhost, Microsoft MVC, RSS, XPATH]
alias: ru/blog/show/159
---
<p>Зарегистрировался на <a href="http://outcoldman.livejournal.com/">livejournal.com</a> я давно, а вот начал пользоваться недавно. К набору друзей я отношусь трепетно, так как я, действительно, читаю френд ленту, сам не ищу новых интересных блоггеров (кстати, может подскажите, кого стоит добавить во френд ленту?), но бывает добавляю на кого напорюсь случайно или кто меня добавит. Так вот, что мне не нравится, так это то, что нет rss своей френд ленты. Порывшись по интернету, я нашел кучу способов преобразования html в rss (есть вариант где чуть ли не ИИ исследовал страницу и находил как верно ее экспортировать в rss), но по настоящему мне ни один способ не подошел – в итоге все равно что-то не работало. Тут у меня и родилась идея создать собственный конвертер из html в rss. Опять таки, порывшись и погуглив я набрел на решение <a href="http://www.codeplex.com/htmlagilitypack">Html Agility Pack</a> (еще смотрел <a href="http://habrahabr.ru/blogs/i_am_advertising/68150/">Data Extracting SDK</a>, но вроде функциональность не та, да и пару необоснованных NullReferenceException сделали свое дело). Если скачать Html Agility Pack – то там даже пример есть как при помощи него сделать rss из html, у меня как раз и была идея: либо разбирать с возможностью настройки на RegEx, либо на XPath (в случае данной библиотеки - это XPath). Правда, HtmlAgilityPack мне тоже пришлось поправить немного, не знаю с чем это связано, но там мне мешал метод MoveToRoot у HtmlNodeNavigator – он вызывался не в совсем нужный момент и мешал мне в разборе (я просто закомментировал его функциональность). </p>

<p>В итоге код, который создавал rss по html для моей френд ленты выглядел так:&#160; </p>  

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">HtmlDocument doc = <span style="color: #0000ff;">new</span> HtmlDocument(); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">doc.Load(MapPath(<span style="color: #006080;">"~/sample.htm"</span>), Encoding.UTF8); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">HtmlNodeCollection entries = doc.DocumentNode.SelectNodes(<span style="color: #006080;">"//div[@class='hentry']"</span>); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">XmlDocument rssDoc = <span style="color: #0000ff;">new</span> XmlDocument(); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">rssDoc.LoadXml(<span style="color: #006080;">"&lt;?xml version=\"1.0\" encoding=\""</span> + doc.Encoding.BodyName + <span style="color: #006080;">"\"?&gt;&lt;rss version=\"0.91\"/&gt;"</span>); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">XmlElement channel = rssDoc.CreateElement(<span style="color: #006080;">"channel"</span>); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">rssDoc.FirstChild.NextSibling.AppendChild(channel); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">XmlElement temp = rssDoc.CreateElement(<span style="color: #006080;">"title"</span>); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">temp.InnerText = <span style="color: #006080;">"ASP.Net articles scrap RSS feed"</span>; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">channel.AppendChild(temp); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">temp = rssDoc.CreateElement(<span style="color: #006080;">"link"</span>); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">temp.InnerText = <span style="color: #006080;">"http://outcoldman.livejournal.com"</span>; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">channel.AppendChild(temp); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">foreach</span> (HtmlNode entry <span style="color: #0000ff;">in</span> entries) </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{ </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    XmlElement item; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    HtmlNode href = entry.SelectSingleNode(<span style="color: #006080;">"//a[@href and @rel='bookmark']"</span>); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// get what's interesting for RSS </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">string</span> link = href.Attributes[<span style="color: #006080;">"href"</span>].Value; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">string</span> title = href.InnerText; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    HtmlNode date = entry.SelectSingleNode(<span style="color: #006080;">"//abbr[@title and @class='updated']"</span>); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// create XML elements </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    item = rssDoc.CreateElement(<span style="color: #006080;">"item"</span>); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    channel.AppendChild(item); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    temp = rssDoc.CreateElement(<span style="color: #006080;">"date"</span>); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    temp.InnerText = date.Attributes[<span style="color: #006080;">"title"</span>].Value; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    item.AppendChild(temp); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    temp = rssDoc.CreateElement(<span style="color: #006080;">"title"</span>); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    temp.InnerText = title; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    item.AppendChild(temp); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    temp = rssDoc.CreateElement(<span style="color: #006080;">"link"</span>); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    temp.InnerText = link; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    item.AppendChild(temp); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">string</span> description = <span style="color: #0000ff;">null</span>; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    HtmlNode descNode = entry.SelectSingleNode(<span style="color: #006080;">"//div[@class='entry-content text']"</span>); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">if</span> (descNode != <span style="color: #0000ff;">null</span>) </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        description = descNode.InnerHtml; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// description is not always here </span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">if</span> (!<span style="color: #0000ff;">string</span>.IsNullOrEmpty(description)) </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    { </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        temp = rssDoc.CreateElement(<span style="color: #006080;">"description"</span>); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        temp.InnerText = description; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        item.AppendChild(temp); </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    } </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">&nbsp;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>Где sample.htm – моя сохраненная страничка. </p>  <p>Ну и раз я начал делать, то решил уж сделать для всех (у меня даже хостинг есть в рамках программы - <a href="http://www.microsoft.com/rus/student/community/masterhost/">Бесплатный веб-хостинг для студентов</a>) – сделать несколько инвайтов, пригласить для начала максимум человек 100 нуждающихся в этом. А потом уже если все пойдет хорошо и всем будет комфортно, то можно и еще инвайтов наделать. Так как нужно делать web-приложение, то сразу родилась идея делать все на <a href="http://www.asp.net/mvc/">Microsoft MVC</a> – надо же когда-нибудь попробовать, ну и как бы вчера сделал небольшой зародыш системы. А сегодня покопавшись на livejournal по поводу правомерности данного действия (кстати, так и не нашел, можно ли делать такой интерфейс или нет) обнаружил, что так как у меня платный (<a href="http://www.livejournal.com/manage/account/">спонсируемый</a>) аккаунт, то оказывается есть возможность экспортировать мою френд ленту в RSS – как это сделать написано тут - <a href="http://community.livejournal.com/howto/40882.html">Friends Page RSS</a>. </p>  <p>В общем свою задумку я замораживаю, так как у меня уже необходимости в ней нет (пока нет), но все же, если наберется хотя бы 20-30 человек, которым данное решение пригодиться – то могу доделать проект и выложить (правда не обещаю как скоро). </p>  
