---
layout: post
title: "WPF 4.0. Что нового? Часть 4."
date: 2010-03-02 13:04:00
categories: ru
tags: [.NET, .NET 4.0, WPF, WPF 4, Visual Studio 2010]
alias: ru/blog/show/188
---
<p>Четвертая часть из серии нововведений WPF 4.0 (Предыдущие записи: <a href="/ru/blog/show/168">1</a>, <a href="/ru/blog/show/169">2</a>, <a href="/ru/blog/show/170">3</a>). Думал, что это будет заключительная, но все же откопал еще несколько вкусностей на следующую часть. В этой же серии в основном будет информация о нововведениях связанных с XAML разметкой и биндингом.</p> 

<h1>XAML</h1>  <h2>Built in Types</h2>  <p>В XAML добавилась возможность использовать стандартные типы .NET в разметке без указания лишних namespace, для чего это стало нужно видно в нижеописанных возможностях. Если раньше для описания в XAML объекта типа string приходилось писать:</p>  

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">s:String</span> <span style="color: #ff0000;">xmlns:s</span><span style="color: #0000ff;">="clr-namespace:System;assembly=mscorlib"</span><span style="color: #0000ff;">&gt;</span> Foo <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">s:String</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>Теперь же</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">x:String</span> <span style="color: #0000ff;">&gt;</span> Foo <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">s:String</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>Все типы перечислены тут - <a href="http://blogs.msdn.com/llobo/archive/2009/11/05/xaml-2009-features-built-in-types.aspx">Xaml 2009 Features: Built in Types</a>.</p>

<h2>Поддержка Generics</h2>

<p>Этого давно не хватало, а именно с выпуска первого WPF. Как часто хотелось объявить в XAML ObservableCollection с типом вроде Person, а для этого нам приходилось создавать новый тип и наследовать его от коллекции, либо инкапсулировать ее:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">class</span> PersonCollection:ObservableCollection&lt;Person&gt;{}</pre><!--CRLF--></div></div>

<p>и уже этот новый класс объявлять в ресурсах:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">l:PersonCollection</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Person</span> <span style="color: #ff0000;">Name</span><span style="color: #0000ff;">="Tom"</span> <span style="color: #0000ff;">/&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">l:PersonCollection</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>Теперь же этого можно избежать, теперь в XAML можно объявлять и инициализировать generics следующим образом:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ObservableCollection</span> <span style="color: #ff0000;">x:TypeArguments</span><span style="color: #0000ff;">='local:Person'</span> <span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">='clr-namespace:System.Collections.ObjectModel;assembly=System'</span>  <span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">local:Person</span> <span style="color: #ff0000;">Name</span><span style="color: #0000ff;">='Tom'</span> <span style="color: #ff0000;">Age</span><span style="color: #0000ff;">='21'</span> <span style="color: #0000ff;">/&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">ObservableCollection</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>Интересные примеры с объявлением Dictionary&lt;Key,Value&gt; можно посмотреть здесь - <a href="http://blogs.msdn.com/llobo/archive/2009/11/19/xaml-2009-features-generics-support.aspx">XAML 2009 Features: Generics Support</a>.</p>

<h2>FactoryMethod\Arguments</h2>

<p>Еще одна возможность, которую хотели уже давно. Возможность использовать методы для инициализации объектов, а так же конструкторы, которые принимают параметры. Для того чтобы создать объект такого типа:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Person </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">public</span> Person (<span style="color: #0000ff;">string</span> name, <span style="color: #0000ff;">int</span> age)</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        Name = name;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        Age = age;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">string</span> Name {get;set;}</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> Age {get;set;}</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>В XAML теперь можно написать </p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">local:Person</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">x:Arguments</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">x:String</span><span style="color: #0000ff;">&gt;</span>Tom<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">x:String</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">x:Int32</span><span style="color: #0000ff;">&gt;</span>21<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">x:Int32</span><span style="color: #0000ff;">&gt;</span>  </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">x:Arguments</span><span style="color: #0000ff;">&gt;</span> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">local:Person</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>



<p>Более того для создания объекта теперь можно использовать FactoryMethod, самый простой пример – это Guid.NewGuid():</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">p:Guid</span> <span style="color: #ff0000;">x:FactoryMethod</span><span style="color: #0000ff;">='NewGuid'</span><span style="color: #0000ff;">/&gt;</span></pre><!--CRLF--></div></div>

<p>Или более сложный пример с передачей параметров:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">coll:List</span> <span style="color: #ff0000;">x:Key</span><span style="color: #0000ff;">='list'</span> <span style="color: #ff0000;">x:TypeArguments</span><span style="color: #0000ff;">='x:String'</span> <span style="color: #ff0000;">x:FactoryMethod</span><span style="color: #0000ff;">='local:Factory.CreateStringList'</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">x:Arguments</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">x:String</span><span style="color: #0000ff;">&gt;</span>Mickey,Donald<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">x:String</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">x:Arguments</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">coll:List</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<h2>Named Object References</h2>

<p>Тут все просто, такой биндинг:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Label</span> <span style="color: #ff0000;">Target</span><span style="color: #0000ff;">='{Binding ElementName=firstNameBox}'</span> <span style="color: #0000ff;">&gt;</span>_Target<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Label</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextBox</span> <span style="color: #ff0000;">Name</span><span style="color: #0000ff;">='firstNameBox'</span><span style="color: #0000ff;">&gt;</span>Uses Binding<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">TextBox</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>


<p>Теперь можно записать при помощи x:Reference</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Label</span> <span style="color: #ff0000;">Target</span>= <span style="color: #0000ff;">'{x:Reference secondNameBox}'</span><span style="color: #0000ff;">&gt;</span>_Second Target<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Label</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>Или даже так:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Label</span> <span style="color: #ff0000;">Target</span>= <span style="color: #0000ff;">'thirdNameBox'</span> <span style="color: #0000ff;">&gt;</span>_Third Target<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Label</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<h2>Binding to Dynamic Objects</h2>

<p>.NET 4 приходит вместе с dynamic, потому и в WPF добавили возможность биндить к свойствам dynamic объектов. Если мы установим такие свойства у объекта:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">dynamic dynamicObj = BindPanel.DataContext ;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">dynamicObj.A = <span style="color: #006080;">"Simple Binding"</span>;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">dynamicObj.B = <span style="color: #0000ff;">new</span> DynamicObjectClass(); </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">dynamicObj.B.C = <span style="color: #006080;">"Nested Prop Binding"</span>;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">dynamicObj.AddItem(<span style="color: #006080;">"item 0"</span>);</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">dynamicObj[0] = <span style="color: #006080;">"Indexer Binding"</span>;</pre><!--CRLF--></div></div>


<p>То мы запросто можем установить такой биндинг:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">StackPanel</span> <span style="color: #ff0000;">Name</span><span style="color: #0000ff;">="BindPanel"</span> <span style="color: #ff0000;">DataContext</span><span style="color: #0000ff;">="{StaticResource MyDynamicObject}"</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextBox</span> <span style="color: #ff0000;">Text</span><span style="color: #0000ff;">="{Binding Path=A}"</span><span style="color: #0000ff;">/&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextBlock</span> <span style="color: #ff0000;">Text</span><span style="color: #0000ff;">="{Binding Path=B.C}"</span> <span style="color: #0000ff;">/&gt;</span></pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">TextBox</span>  <span style="color: #ff0000;">Text</span><span style="color: #0000ff;">="{Binding Path=[(x:Int32)0]}"</span><span style="color: #0000ff;">/&gt;</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">StackPanel</span><span style="color: #0000ff;">&gt;</span></pre><!--CRLF--></div></div>

<p>Эта возможность тоже даст пищу для размышлений. Теперь можно придумать о быстрой реализации биндинга к DataSet или XMLDocument.</p>
<p>
<a rev="vote-for" href="http://progg.ru/outcoldman-WPF-40-%D0%A7%D1%82%D0%BE-%D0%BD%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE-%D0%A7%D0%B0%D1%81%D1%82%D1%8C-4"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.livejournal.com%2F51096.html" style="border:0px" /></a></p>
