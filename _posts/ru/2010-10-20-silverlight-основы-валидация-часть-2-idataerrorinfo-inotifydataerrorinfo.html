---
layout: post
title: "Silverlight. Основы. Валидация. Часть 2. IDataErrorInfo & INotifyDataErrorInfo"
date: 2010-10-20 13:51:00
categories: ru
tags: [Silverlight, XAML, Validation]
alias: ru/blog/show/250
---
<p>Буквально вчера написал <a href="/ru/blog/show/249">первую часть</a> статьи про валидацию введённых данных в Silverlight, сегодня хочу продолжить эту тему, чтобы не откладывать в дальний ящик. В этой части я попробую дополнить первую часть, скажу еще, что не сказал про DataAnnotations, а так же опишу интерфейсы <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.idataerrorinfo(VS.95).aspx">IDataErrorInfo</a> и <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.inotifydataerrorinfo(VS.95).aspx">INotifyDataErrorInfo</a>. Рекомендую прочесть <a href="/ru/blog/show/249">первую часть статьи</a> перед прочтением этой, потому как я буду использовать все тот же пример.</p>    <h2>Еще пару слов про ValidatesOnExceptions</h2>  <p>Забыл сказать, что если вам хочется построить валидацию на исключениях, то совсем не обязательно использовать DataAnnotations, можно очень просто выбрасывать исключения прям из set методов. Например, для проверки того, что повторно введенный пароль из прошлого примера совпадает с перво-введённым паролем, можно сделать так:</p>  <div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">   <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">     <pre style="background-color: white; margin: 0em">[Display(Name = <span style="color: #006080">&quot;New password confirmation&quot;</span>)]</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPasswordConfirmation</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    get { <span style="color: #0000ff">return</span> _newPasswordConfirmation; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    set</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        _newPasswordConfirmation = <span style="color: #0000ff">value</span>;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        OnPropertyChanged(<span style="color: #006080">&quot;NewPasswordConfirmation&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        ChangePasswordCommand.RaiseCanExecuteChanged();</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">if</span> (<span style="color: #0000ff">string</span>.CompareOrdinal(_newPassword, <span style="color: #0000ff">value</span>) != 0)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> Exception(<span style="color: #006080">&quot;Password confirmation not equal to password.&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Так, конечно, выглядит намного проще, чем описывать все на аттрибутах (в случае CustomValidationAttribute).</p>

<h2>IDataErrorInfo</h2>

<p><a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.idataerrorinfo(VS.95).aspx">IDataErrorInfo</a> интерфейс пришел вместе с Silverlight 4. Он нам поможет избавиться от передачи сообщений об ошибках инфраструктуре Silverlight основанной на бросании исключений. Все, что нужно сделать – это реализовать два описанных в этом интерфейсе метода/свойства. Чаще всего разработчики начинают с того, что <a href="http://johnpapa.net/silverlight/enabling-validation-in-silverlight-4-with-idataerrorinfo/">добавляют некий класс-обработчик</a>, который хранит коллекцию сообщений об ошибках:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> ValidationHandler</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> Dictionary&lt;<span style="color: #0000ff">string</span>, <span style="color: #0000ff">string</span>&gt; BrokenRules { get; set; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> ValidationHandler()</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        BrokenRules = <span style="color: #0000ff">new</span> Dictionary&lt;<span style="color: #0000ff">string</span>, <span style="color: #0000ff">string</span>&gt;();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> <span style="color: #0000ff">this</span>[<span style="color: #0000ff">string</span> property]</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> BrokenRules[property]; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">bool</span> BrokenRuleExists(<span style="color: #0000ff">string</span> property)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">return</span> BrokenRules.ContainsKey(property);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">bool</span> ValidateRule(<span style="color: #0000ff">string</span> property, <span style="color: #0000ff">string</span> message, Func&lt;<span style="color: #0000ff">bool</span>&gt; ruleCheck)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">bool</span> check = ruleCheck();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (!check)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">if</span> (BrokenRuleExists(property))</pre>
<!--CRLF-->

    <pre style="margin: 0em">                RemoveBrokenRule(property);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            BrokenRules.Add(property, message);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">else</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="margin: 0em">            RemoveBrokenRule(property);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">return</span> check;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> RemoveBrokenRule(<span style="color: #0000ff">string</span> property)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (BrokenRules.ContainsKey(property))</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            BrokenRules.Remove(property);</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Clear()</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        BrokenRules.Clear();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Дальше, давайте перепишем немного наш класс BindingModel, наследуем его от вышеупомянутого интерфейса и реализуем его при помощи класса ValidationHandler:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> BindingModel : INotifyPropertyChanged, IDataErrorInfo</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">string</span> _newPassword;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">string</span> _newPasswordConfirmation;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">readonly</span> ValidationHandler _validationHandler = <span style="color: #0000ff">new</span> ValidationHandler();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #cc6633">#region</span> INotifyPropertyChanged</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">event</span> PropertyChangedEventHandler PropertyChanged = <span style="color: #0000ff">delegate</span> { };</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> OnPropertyChanged(<span style="color: #0000ff">string</span> propertyName)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        PropertyChanged(<span style="color: #0000ff">this</span>, <span style="color: #0000ff">new</span> PropertyChangedEventArgs(propertyName));</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #cc6633">#endregion</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #cc6633">#region</span> IDataErrorInfo</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> <span style="color: #0000ff">this</span>[<span style="color: #0000ff">string</span> columnName]</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">if</span> (_validationHandler.BrokenRuleExists(columnName))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            {</pre>
<!--CRLF-->

    <pre style="margin: 0em">                <span style="color: #0000ff">return</span> _validationHandler[columnName];</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            }</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">return</span> <span style="color: #0000ff">null</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Error</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> NotImplementedException(); }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #cc6633">#endregion</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Основные свойства нашей BindingModel будут описаны следующим образом:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em">[Display(Name = <span style="color: #006080">&quot;New password&quot;</span>)]</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPassword</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    get { <span style="color: #0000ff">return</span> _newPassword; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    set</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        _newPassword = <span style="color: #0000ff">value</span>;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        OnPropertyChanged(<span style="color: #006080">&quot;NewPassword&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">if</span> (_validationHandler.ValidateRule(<span style="color: #006080">&quot;NewPassword&quot;</span>, <span style="color: #006080">&quot;New password required&quot;</span>, </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                    () =&gt; !<span style="color: #0000ff">string</span>.IsNullOrEmpty(<span style="color: #0000ff">value</span>)))</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            _validationHandler.ValidateRule(<span style="color: #006080">&quot;NewPassword&quot;</span>, <span style="color: #006080">&quot;Max length of password is 80 symbols.&quot;</span>, </pre>
<!--CRLF-->

    <pre style="margin: 0em">                                    () =&gt; <span style="color: #0000ff">value</span>.Length &lt; 80);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        ChangePasswordCommand.RaiseCanExecuteChanged();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">[Display(Name = <span style="color: #006080">&quot;New password confirmation&quot;</span>)]</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPasswordConfirmation</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    get { <span style="color: #0000ff">return</span> _newPasswordConfirmation; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    set</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        _newPasswordConfirmation = <span style="color: #0000ff">value</span>;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        OnPropertyChanged(<span style="color: #006080">&quot;NewPasswordConfirmation&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        _validationHandler.ValidateRule(<span style="color: #006080">&quot;NewPasswordConfirmation&quot;</span>, <span style="color: #006080">&quot;Password confirmation not equal to password.&quot;</span>,</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                        () =&gt; <span style="color: #0000ff">string</span>.CompareOrdinal(_newPassword, <span style="color: #0000ff">value</span>) == 0);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        ChangePasswordCommand.RaiseCanExecuteChanged();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>То есть, каждый вызов метода ValidateRule проверяет некоторое условие, и если оно не выполнилось, то записывает информацию о нем в коллекцию ошибок. После байдинга произойдет обращение к индексируемому свойству <em>this[string columnName]</em> и оно вернет сообщение об ошибке. Для того, чтобы это работало в байдинге мы установили свойство <a href="http://msdn.microsoft.com/en-us/library/system.windows.data.binding.validatesondataerrors(VS.95).aspx">ValidatesOnDataErrors</a> в <em>True</em>. Свойство Error кидает <em>NotImplementedException()</em> не просто так, в нем нет необходимости, если вы сами его не используете. Цитата с <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.idataerrorinfo(VS.95).aspx">MSDN</a>: “<em>Note that the binding engine never uses the </em><a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.idataerrorinfo.error(VS.95).aspx"><em>Error</em></a><em> property, although you can use it in custom error reporting to display object-level errors.</em>”. То есть, инфраструктура Silverlight его не использует при байдинге. </p>

<p>Давайте заканчивать с этим примером. Все, что нам осталось – это реализовать и проинициализировать команду, которая будет производить изменение пароля. Сделаем это так:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> BindingModel()</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    ChangePasswordCommand = <span style="color: #0000ff">new</span> DelegateCommand(ChangePassword, CanChangePassword);</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">public</span> DelegateCommand ChangePasswordCommand { get; <span style="color: #0000ff">private</span> set; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">private</span> <span style="color: #0000ff">bool</span> CanChangePassword(<span style="color: #0000ff">object</span> arg)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">return</span> !<span style="color: #0000ff">string</span>.IsNullOrEmpty(_newPassword) </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        &amp;&amp; <span style="color: #0000ff">string</span>.CompareOrdinal(_newPassword, _newPasswordConfirmation) == 0;</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> ChangePassword(<span style="color: #0000ff">object</span> obj)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">if</span> (ChangePasswordCommand.CanExecute(obj))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        MessageBox.Show(<span style="color: #006080">&quot;Bingo!&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Нам опять нужно использовать <em>CanChangePassword</em> метод, чтобы делать кнопку неактивной при невалидности объекта. У нас нет возможности как-то проверить валидность всего объекта, пока не произошел байдинг по каждому полю. Так же, в нашей реализации нам приходится описывать правила валидации дважды, один раз при байдинге, а второй раз на проверку того, можно ли вызвать команду. Это проблемы только нашей реализации (точнее той, что я взял по ссылке выше). Решить эту проблему можно, например, записывая сами правила в тот же <em>ValidationHandler</em>, и умея проходить по всем этим правилам, и в целом получать общую картину о валидности состояния объекта. Но, все же, одно проблема останется, мы не можем прямо из кода, из метода <em>ChangePassword</em> (нажатия на кнопку) сказать инфраструктуре, что ошибки появились или, наоборот, пропали. Можно так же использовать атрибуты из DataAnnotations для описания условий. Но об этом мы поговорим в рамках следующего интерфейса, который, мне кажется, является лучшим выбором для реализации валидации. </p>

<p>Результат этой реализации привожу ниже (Silverlight приложение):</p>
<object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="100%" height="150px">
		  <param name="source" value="/library/content/03/SLValidation/SilverlightValidation2.xap" />
		  <param name="background" value="white" />
		  <param name="minRuntimeVersion" value="4.0.50826.0" />
		  <param name="autoUpgrade" value="true" />
		  <a href="http://go.microsoft.com/fwlink/?LinkID=149156&amp;v=4.0.50826.0" style="text-decoration:none">
 			  <img src="http://go.microsoft.com/fwlink/?LinkId=161376" alt="Get Microsoft Silverlight" style="border-style:none" />
		  </a>
	    </object>

<p>Думаю, его поведение не сильно должно отличаться от предыдущего примера (в предыдущей части статьи). Но вот хочется отметить, что здесь есть скрытый баг. Если пользователь сначала введет <em>Password Confirmation</em> а затем <em>New Password</em>, то останется ошибка о неверном введенном подтверждении пароля, так как эта проверка происходит только на байдинг <em>New Password Confirmation</em> свойства. </p>

<h2>INotifyDataErrorInfo</h2>

<p><a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.inotifydataerrorinfo(VS.95).aspx">INotifyDataErrorInfo</a> интерфейс к нам так же пришел совместно с Silverlight 4. Основное его преимущество в том, что он может осуществлять как синхронную (как было в предыдущих примерах) так и асинхронную валидацию. Например, подождать, когда проверка придет от сервера, и только потом показать сообщение об ошибке. Вот этот метод я хочу описать более подробно, насколько это возможно. Помогут реализовать валидацию при помощи INotifyDataErrorInfo статьи, опубликованные <a href="http://davybrion.com">Davy Brion</a> в рамках “<a href="http://davybrion.com/blog/2010/08/mvp-in-silverlightwpf-series/">MVP In Silverlight/WPF Series</a>”. </p>

<p>Для начала возьмем класс <em>PropertyValidation</em>, при помощи которого мы будем хранить информацию о каждом правиле валидации, и о том, какое сообщение отображать при этом:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> PropertyValidation&lt;TBindingModel&gt;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">where</span> TBindingModel : BindingModelBase&lt;TBindingModel&gt;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> Func&lt;TBindingModel, <span style="color: #0000ff">bool</span>&gt; _validationCriteria;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">string</span> _errorMessage;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">readonly</span> <span style="color: #0000ff">string</span> _propertyName;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> PropertyValidation(<span style="color: #0000ff">string</span> propertyName)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        _propertyName = propertyName;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> PropertyValidation&lt;TBindingModel&gt; When(Func&lt;TBindingModel, <span style="color: #0000ff">bool</span>&gt; validationCriteria)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (_validationCriteria != <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> InvalidOperationException(<span style="color: #006080">&quot;You can only set the validation criteria once.&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        _validationCriteria = validationCriteria;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">return</span> <span style="color: #0000ff">this</span>;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> PropertyValidation&lt;TBindingModel&gt; Show(<span style="color: #0000ff">string</span> errorMessage)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">if</span> (_errorMessage != <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> InvalidOperationException(<span style="color: #006080">&quot;You can only set the message once.&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        _errorMessage = errorMessage;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">return</span> <span style="color: #0000ff">this</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">bool</span> IsInvalid(TBindingModel presentationModel)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (_validationCriteria == <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> InvalidOperationException(</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                <span style="color: #006080">&quot;No criteria have been provided for this validation. (Use the 'When(..)' method.)&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">return</span> _validationCriteria(presentationModel);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> GetErrorMessage()</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">if</span> (_errorMessage == <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> InvalidOperationException(</pre>
<!--CRLF-->

    <pre style="margin: 0em">                <span style="color: #006080">&quot;No error message has been set for this validation. (Use the 'Show(..)' method.)&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">return</span> _errorMessage;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> PropertyName</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        get { <span style="color: #0000ff">return</span> _propertyName; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Как он работает будет понятно ниже, когда мы будем описывать правила валидации. В качестве Generic Type параметра у нас используется базовый класс <em>BindingModelBase&lt;T&gt;</em>, от которого мы потом наследуем наш основной класс <em>BindingModel</em> примера. </p>

<p>Давайте приступим к реализации класса <em>BindingModelBase</em>, его мы наследуем от <em>INotifyPropertyChanged</em> и от <em>INotifyDataErrorInfo</em>, добавим так же два поля. Одно для хранения ошибок для свойств, второе для хранения правил валидации:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">abstract</span> <span style="color: #0000ff">class</span> BindingModelBase&lt;TBindingModel&gt; : INotifyPropertyChanged, INotifyDataErrorInfo</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">where</span> TBindingModel : BindingModelBase&lt;TBindingModel&gt;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">readonly</span> List&lt;PropertyValidation&lt;TBindingModel&gt;&gt; _validations = <span style="color: #0000ff">new</span> List&lt;PropertyValidation&lt;TBindingModel&gt;&gt;();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> Dictionary&lt;<span style="color: #0000ff">string</span>, List&lt;<span style="color: #0000ff">string</span>&gt;&gt; _errorMessages = <span style="color: #0000ff">new</span> Dictionary&lt;<span style="color: #0000ff">string</span>, List&lt;<span style="color: #0000ff">string</span>&gt;&gt;();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #cc6633">#region</span> INotifyDataErrorInfo</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> IEnumerable GetErrors(<span style="color: #0000ff">string</span> propertyName)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (_errorMessages.ContainsKey(propertyName)) </pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">return</span> _errorMessages[propertyName];</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">return</span> <span style="color: #0000ff">new</span> <span style="color: #0000ff">string</span>[0];</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">bool</span> HasErrors</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        get { <span style="color: #0000ff">return</span> _errorMessages.Count &gt; 0; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">event</span> EventHandler&lt;DataErrorsChangedEventArgs&gt; ErrorsChanged = <span style="color: #0000ff">delegate</span> { };</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> OnErrorsChanged(<span style="color: #0000ff">string</span> propertyName)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        ErrorsChanged(<span style="color: #0000ff">this</span>, <span style="color: #0000ff">new</span> DataErrorsChangedEventArgs(propertyName));</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #cc6633">#endregion</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #cc6633">#region</span> INotifyPropertyChanged</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">event</span> PropertyChangedEventHandler PropertyChanged = <span style="color: #0000ff">delegate</span> { };</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">protected</span> <span style="color: #0000ff">void</span> OnPropertyChanged(<span style="color: #0000ff">string</span> propertyName)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        PropertyChanged(<span style="color: #0000ff">this</span>, <span style="color: #0000ff">new</span> PropertyChangedEventArgs(propertyName));</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #cc6633">#endregion</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Реализация пока очень простая. Так же я хотел бы добавить два метода дополнительно к OnPropertyChanged к этому классу. Первый метод OnCurrentPropertyChanged() (<b>на самом деле - это вредный совет, и метод очень опасный, более подробно можно узнать об этом в этом <a href="/ru/blog/show/250#comment_1023">комментарии</a>, если будете пользоваться, то пользуйтесь с умом</b>), который позволит нам делать так:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPassword</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    get { <span style="color: #0000ff">return</span> _newPassword; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    set { _newPassword = <span style="color: #0000ff">value</span>; OnCurrentPropertyChanged(); }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Второй метод OnPropertyChanged, который принимает Expression и позволяет делать так:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPassword</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    get { <span style="color: #0000ff">return</span> _newPassword; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    set { _newPassword = <span style="color: #0000ff">value</span>; OnPropertyChanged(() =&gt; NewPassword); }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Оба метода очень полезны и удобны. Позволяют в разы писать более надежные приложения, и более быстро. Тут многие скажут о производительности, но в чем проблема? Будут проблемы с производительностью – мы знаем где искать эту проблему. Да и не будет их. Эти операции выполняются только на действия пользователя, отклик к которым будет через 10 миллисекунд или через 100, особо не будет никого напрягать. Реализация этих методов следующая:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">protected</span> <span style="color: #0000ff">void</span> OnPropertyChanged(Expression&lt;Func&lt;<span style="color: #0000ff">object</span>&gt;&gt; expression)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    OnPropertyChanged(GetPropertyName(expression));</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">protected</span> <span style="color: #0000ff">void</span> OnCurrentPropertyChanged()</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">string</span> methodName = <span style="color: #0000ff">string</span>.Empty;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    StackTrace stackTrace = <span style="color: #0000ff">new</span> StackTrace(); <span style="color: #008000">// get call stack</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    StackFrame[] stackFrames = stackTrace.GetFrames(); <span style="color: #008000">// get method calls (frames)</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (stackFrames != <span style="color: #0000ff">null</span> &amp;&amp; stackFrames.Length &gt; 1)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        methodName = stackFrames[1].GetMethod().Name;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    </pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">if</span> (!methodName.StartsWith(<span style="color: #006080">&quot;set_&quot;</span>, StringComparison.OrdinalIgnoreCase))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> NotSupportedException(<span style="color: #006080">&quot;OnCurrentPropertyChanged should be invoked only in property setter&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">string</span> propertyName = methodName.Substring(4);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    OnPropertyChanged(propertyName);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">string</span> GetPropertyName(Expression&lt;Func&lt;<span style="color: #0000ff">object</span>&gt;&gt; expression)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (expression == <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ArgumentNullException(<span style="color: #006080">&quot;expression&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    MemberExpression memberExpression;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">if</span> (expression.Body <span style="color: #0000ff">is</span> UnaryExpression)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        memberExpression = ((UnaryExpression)expression.Body).Operand <span style="color: #0000ff">as</span> MemberExpression;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">else</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        memberExpression = expression.Body <span style="color: #0000ff">as</span> MemberExpression;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (memberExpression == <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ArgumentException(<span style="color: #006080">&quot;The expression is not a member access expression&quot;</span>, <span style="color: #006080">&quot;expression&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    var property = memberExpression.Member <span style="color: #0000ff">as</span> PropertyInfo;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (property == <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ArgumentException(<span style="color: #006080">&quot;The member access expression does not access a property&quot;</span>, <span style="color: #006080">&quot;expression&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    var getMethod = property.GetGetMethod(<span style="color: #0000ff">true</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (getMethod.IsStatic)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ArgumentException(<span style="color: #006080">&quot;The referenced property is a static property&quot;</span>, <span style="color: #006080">&quot;expression&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">return</span> memberExpression.Member.Name;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Метод с <em>Expression</em> берет имя свойства из этого <em>Expression</em>. Метод <em>OnCurrentPropertyChanged</em> берет имя свойства из StackTrace. </p>

<p>Теперь давайте добавим набор методов, которые будут осуществлять валидацию:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> ValidateProperty(Expression&lt;Func&lt;<span style="color: #0000ff">object</span>&gt;&gt; expression)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    ValidateProperty(GetPropertyName(expression));</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> ValidateProperty(<span style="color: #0000ff">string</span> propertyName)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    _errorMessages.Remove(propertyName);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    _validations.Where(v =&gt; v.PropertyName == propertyName).ToList().ForEach(PerformValidation);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    OnErrorsChanged(propertyName);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    OnPropertyChanged(() =&gt; HasErrors);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> PerformValidation(PropertyValidation&lt;TBindingModel&gt; validation)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (validation.IsInvalid((TBindingModel) <span style="color: #0000ff">this</span>))</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        AddErrorMessageForProperty(validation.PropertyName, validation.GetErrorMessage());</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> AddErrorMessageForProperty(<span style="color: #0000ff">string</span> propertyName, <span style="color: #0000ff">string</span> errorMessage)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (_errorMessages.ContainsKey(propertyName))</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        _errorMessages[propertyName].Add(errorMessage);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">else</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        _errorMessages.Add(propertyName, <span style="color: #0000ff">new</span> List&lt;<span style="color: #0000ff">string</span>&gt; {errorMessage});</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Метод <em>ValidateProperty</em> удаляет информацию о всех предыдущих ошибках для этого свойства, потом проверяет каждое правило валидации, которое приписано к данному свойству, и если какое-то правило не прошло проверку, то записывает ошибку в список ошибок для конкретного свойства. Более того, мы можем вызывать валидацию автоматически для каждого обновленного поля, если было вызвано событие PropertyChanged, для этого мы проинициализируем следующим образом наш базовый класс:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">protected</span> BindingModelBase()</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    PropertyChanged += (s, e) =&gt; { <span style="color: #0000ff">if</span> (e.PropertyName != <span style="color: #006080">&quot;HasErrors&quot;</span>) ValidateProperty(e.PropertyName); };</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Для того, чтобы добавлять правила в список правил валидации добавим специальный метод:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">protected</span> PropertyValidation&lt;TBindingModel&gt; AddValidationFor(Expression&lt;Func&lt;<span style="color: #0000ff">object</span>&gt;&gt; expression)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    var validation = <span style="color: #0000ff">new</span> PropertyValidation&lt;TBindingModel&gt;(GetPropertyName(expression));</pre>
<!--CRLF-->

    <pre style="margin: 0em">    _validations.Add(validation);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">return</span> validation;</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Теперь мы можем приступить непосредственно к написанию класса <em>BindingModel</em>, который используется в нашем примере. Чтобы работала валидация, основанная на <em>INotifyDataErrorInfo</em>, у нас в байдинге свойств Xaml описания стоит <a href="http://msdn.microsoft.com/en-us/library/system.windows.data.binding.validatesonnotifydataerrors(VS.95).aspx">ValidatesOnNotifyDataErrors</a> равное True.</p>

<p>Вот как будет выглядеть класс <em>BindingModel</em> в данной реализации:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> BindingModel : BindingModelBase&lt;BindingModel&gt;</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">string</span> _newPassword;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">string</span> _newPasswordConfirmation;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> DelegateCommand ChangePasswordCommand { get; <span style="color: #0000ff">private</span> set; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> BindingModel()</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        ChangePasswordCommand = <span style="color: #0000ff">new</span> DelegateCommand(ChangePassword);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        AddValidationFor(() =&gt; NewPassword)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            .When(x =&gt; <span style="color: #0000ff">string</span>.IsNullOrEmpty(x._newPassword))</pre>
<!--CRLF-->

    <pre style="margin: 0em">            .Show(<span style="color: #006080">&quot;New password required field.&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        AddValidationFor(() =&gt; NewPassword)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            .When(x =&gt; !<span style="color: #0000ff">string</span>.IsNullOrEmpty(x._newPassword) &amp;&amp; x._newPassword.Length &gt; 80)</pre>
<!--CRLF-->

    <pre style="margin: 0em">            .Show(<span style="color: #006080">&quot;New password must be a string with maximum length of 80.&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        AddValidationFor(() =&gt; NewPasswordConfirmation)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            .When(x =&gt; !<span style="color: #0000ff">string</span>.IsNullOrEmpty(x._newPassword) &amp;&amp; <span style="color: #0000ff">string</span>.CompareOrdinal(x._newPassword, x._newPasswordConfirmation) != 0)</pre>
<!--CRLF-->

    <pre style="margin: 0em">            .Show(<span style="color: #006080">&quot;Password confirmation not equal to password.&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    [Display(Name = <span style="color: #006080">&quot;New password&quot;</span>)]</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPassword</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> _newPassword; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            _newPassword = <span style="color: #0000ff">value</span>;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            OnCurrentPropertyChanged();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    </pre>
<!--CRLF-->

    <pre style="margin: 0em">    [Display(Name = <span style="color: #006080">&quot;New password confirmation&quot;</span>)]</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPasswordConfirmation</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        get { <span style="color: #0000ff">return</span> _newPasswordConfirmation; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">        set</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="margin: 0em">            _newPasswordConfirmation = <span style="color: #0000ff">value</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            OnCurrentPropertyChanged();</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> ChangePassword(<span style="color: #0000ff">object</span> obj)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> NotImplementedException();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>В конструкторе класса мы описываем при помощи <em>PropertyValidation</em> все три наших правила. Выглядит очень читабельно, вроде. Я больше не хочу делать неактивной кнопку для изменения пароля, потому избавился от метода <em>CanChangePassword</em>. Но пока и не реализовал сам метод <em>ChangePassword</em>. Для того чтобы реализовать метод мне нужен метод, который бы валидировал все свойства (полностью состояние объекта), отображал бы ошибки на форме, а так же давал мне знать о том, валидна форма или нет. Для этого в классе <em>BindingModelBase</em> я реализую метод <em>ValidateAll</em>:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> ValidateAll()</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    var propertyNamesWithValidationErrors = _errorMessages.Keys;</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    _errorMessages = <span style="color: #0000ff">new</span> Dictionary&lt;<span style="color: #0000ff">string</span>, List&lt;<span style="color: #0000ff">string</span>&gt;&gt;();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    _validations.ForEach(PerformValidation);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    var propertyNamesThatMightHaveChangedValidation =</pre>
<!--CRLF-->

    <pre style="margin: 0em">        _errorMessages.Keys.Union(propertyNamesWithValidationErrors).ToList();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    propertyNamesThatMightHaveChangedValidation.ForEach(OnErrorsChanged);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    OnPropertyChanged(() =&gt; HasErrors);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Данный метод чистит все ошибки. Потом делает проверку для нашего правила (записывается ошибка, если нужно), а дальше для всех свойств, для которых могло бы поменяться состояние валидно оно или нет, вызываем метод <em>OnErrorsChanged</em>. </p>

<p>Реализация метода <em>ChangePassword </em>(проверяем все свойства, и если ошибок нет – можем произвести действие):</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> ChangePassword(<span style="color: #0000ff">object</span> obj)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    ValidateAll();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (!HasErrors)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        MessageBox.Show(<span style="color: #006080">&quot;Bingo!&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Результат (Silverlight приложение):</p>
<object data="data:application/x-silverlight-2," type="application/x-silverlight-2" width="100%" height="150px">
		  <param name="source" value="/library/content/03/SLValidation/SilverlightValidation3.xap" />
		  <param name="background" value="white" />
		  <param name="minRuntimeVersion" value="4.0.50826.0" />
		  <param name="autoUpgrade" value="true" />
		  <a href="http://go.microsoft.com/fwlink/?LinkID=149156&amp;v=4.0.50826.0" style="text-decoration:none">
 			  <img src="http://go.microsoft.com/fwlink/?LinkId=161376" alt="Get Microsoft Silverlight" style="border-style:none" />
		  </a>
	    </object>

<p>Данный вариант для валидации мне нравится больше всего. Он намного более гибкий, и более того, он может использовать преимущества всех предыдущих вариантов. А как же DataAnnotations? Нравится использование аттрибутов для описания правил валидации? Давайте напишем метод, который будет собирать все такие правила и преобразовывать в <em>PropertyValidation</em> (изменим так же немного метод AddValidatorFor, точнее сделаем два возможных варианта для его вызова):</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">protected</span> PropertyValidation&lt;TBindingModel&gt; AddValidationFor(Expression&lt;Func&lt;<span style="color: #0000ff">object</span>&gt;&gt; expression)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">return</span> AddValidationFor(GetPropertyName(expression));</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">protected</span> PropertyValidation&lt;TBindingModel&gt; AddValidationFor(<span style="color: #0000ff">string</span> propertyName)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    var validation = <span style="color: #0000ff">new</span> PropertyValidation&lt;TBindingModel&gt;(propertyName);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    _validations.Add(validation);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">return</span> validation;</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">protected</span> <span style="color: #0000ff">void</span> AddAllAttributeValidators()</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">    PropertyInfo[] propertyInfos = GetType().GetProperties(BindingFlags.Public | BindingFlags.Instance);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">foreach</span> (PropertyInfo propertyInfo <span style="color: #0000ff">in</span> propertyInfos)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        Attribute[] custom = Attribute.GetCustomAttributes(propertyInfo, <span style="color: #0000ff">typeof</span>(ValidationAttribute), <span style="color: #0000ff">true</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">foreach</span> (var attribute <span style="color: #0000ff">in</span> custom)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            var property = propertyInfo;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            var validationAttribute = attribute <span style="color: #0000ff">as</span> ValidationAttribute;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">if</span> (validationAttribute == <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> NotSupportedException(<span style="color: #006080">&quot;validationAttribute variable should be inherited from ValidationAttribute type&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">string</span> name = property.Name;</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            var displayAttribute = Attribute.GetCustomAttributes(propertyInfo, <span style="color: #0000ff">typeof</span>(DisplayAttribute)).FirstOrDefault() <span style="color: #0000ff">as</span> DisplayAttribute;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">if</span> (displayAttribute != <span style="color: #0000ff">null</span>)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            {</pre>
<!--CRLF-->

    <pre style="margin: 0em">                name = displayAttribute.GetName();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            var message = validationAttribute.FormatErrorMessage(name);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            AddValidationFor(propertyInfo.Name)</pre>
<!--CRLF-->

    <pre style="margin: 0em">                .When(x =&gt;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                {</pre>
<!--CRLF-->

    <pre style="margin: 0em">                    var <span style="color: #0000ff">value</span> = property.GetGetMethod().Invoke(<span style="color: #0000ff">this</span>, <span style="color: #0000ff">new</span> <span style="color: #0000ff">object</span>[] { });</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                    var result = validationAttribute.GetValidationResult(<span style="color: #0000ff">value</span>,</pre>
<!--CRLF-->

    <pre style="margin: 0em">                                                            <span style="color: #0000ff">new</span> ValidationContext(<span style="color: #0000ff">this</span>, <span style="color: #0000ff">null</span>, <span style="color: #0000ff">null</span>) { MemberName = property.Name });</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                    <span style="color: #0000ff">return</span> result != ValidationResult.Success;</pre>
<!--CRLF-->

    <pre style="margin: 0em">                })</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                .Show(message);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF--></div>
</div>
Метод <em>AddAllAttributeValidators</em> не протестирован особо, так что используете на свой страх и риск. Скорее всего будет поддерживаться локализация (если указываете ресурсы для аттрибутов, а не сообщения об ошибках). Последнее переписывание нашей модели <em>BindingModel</em>:

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> BindingModel : BindingModelBase&lt;BindingModel&gt;</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">string</span> _newPassword;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">string</span> _newPasswordConfirmation;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> DelegateCommand ChangePasswordCommand { get; <span style="color: #0000ff">private</span> set; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> BindingModel()</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        ChangePasswordCommand = <span style="color: #0000ff">new</span> DelegateCommand(ChangePassword);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        AddAllAttributeValidators();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        AddValidationFor(() =&gt; NewPasswordConfirmation)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            .When(x =&gt; !<span style="color: #0000ff">string</span>.IsNullOrEmpty(x._newPassword) &amp;&amp; <span style="color: #0000ff">string</span>.CompareOrdinal(x._newPassword, x._newPasswordConfirmation) != 0)</pre>
<!--CRLF-->

    <pre style="margin: 0em">            .Show(<span style="color: #006080">&quot;Password confirmation not equal to password.&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    [Display(Name = <span style="color: #006080">&quot;New password&quot;</span>)]</pre>
<!--CRLF-->

    <pre style="margin: 0em">    [Required]</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    [StringLength(80, ErrorMessage = <span style="color: #006080">&quot;New password must be a string with maximum length of 80.&quot;</span>)]</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPassword</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        get { <span style="color: #0000ff">return</span> _newPassword; }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        set</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            _newPassword = <span style="color: #0000ff">value</span>;</pre>
<!--CRLF-->

    <pre style="margin: 0em">            OnCurrentPropertyChanged();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    [Display(Name = <span style="color: #006080">&quot;New password confirmation&quot;</span>)]</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> NewPasswordConfirmation</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        get { <span style="color: #0000ff">return</span> _newPasswordConfirmation; }</pre>
<!--CRLF-->

    <pre style="margin: 0em">        set</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="margin: 0em">            _newPasswordConfirmation = <span style="color: #0000ff">value</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            OnCurrentPropertyChanged();</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">private</span> <span style="color: #0000ff">void</span> ChangePassword(<span style="color: #0000ff">object</span> obj)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        ValidateAll();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">if</span> (!HasErrors)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            MessageBox.Show(<span style="color: #006080">&quot;Bingo!&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>

<p>Специально оставил солянку из двух подходов. Все работает, поведение такое же, как в последнем примере. </p>

<p>Исходный код этих примеров можно скачать с моего репозитария на <a href="https://www.assembla.com/code/outcoldman_p/subversion/nodes/BlogProjects/SilverlightValidation?rev=10">assembla.com</a>.</p>
