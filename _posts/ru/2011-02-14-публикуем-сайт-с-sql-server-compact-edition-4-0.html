---
layout: post
title: "Публикуем сайт с SQL Server Compact Edition 4.0"
date: 2011-02-14 11:30:00
categories: ru
tags: [SQL Server, outcoldman.ru, Entity Framework, SQL Server Compact, SQL Server CE, SQL Server CE 4, Membership]
alias: ru/blog/show/273
---
<p>Меня, честно, даже обрадовало то, что можно теперь разрабатывать сайты с использованием SQL Server Compact Edition 4.0. Отдельная База Данных иногда бывает провокатором проблем и ошибок: у хостера ваш сосед по БД может сильно перезагрузить сервер БД, и у вас начнется что-то отваливаться (либо хостер может перегрузить сервер БД слишком большим количеством баз данных). С SQL Server Compact Edition 4.0 наш сайт уже не зависит от внешней БД, она у нас локальная, крутится вместе с нашим приложением. Уж очень удобно забирать всегда последнюю версию файла базы данных, легко обновлять – нужно просто скопировать файл. В общем, на момент выхода статьи мой сайт будет крутиться на SQL Server Compact Edition 4.0 уже как месяц (проблем не было никаких). Рекомендую задуматься, если у вас сайт, вроде блога, небольшого онлайн магазина, о том, чтобы перевести (или разрабатывать новое) с использованием SQL Server CE 4.</p>    <h2>Что нужно, чтобы начать работать с SQL Server Compact Edition 4.0?</h2>  <p>Скажу честно, что изначально я потратил достаточно много времени на то, чтобы найти какую-нибудь нормальную утилиту для работы с базами данных SQL Server CE 4.0. Итак для начала, если вы еще не скачали сам SQL Server Compact Edition 4.0, то скачиваем его с <a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=033CFB76-5382-44FB-BC7E-B3C8174832E2">download сайта</a>. Затем, в принципе, уже можно работать с CE, только непонятно чем. Меня вот особо повеселил парень, написавший вот эту статью <a href="http://deanhume.com/Home/BlogPost/a-simple-guide-to-sql-compact-4/31">A Simple Guide to SQL Compact 4</a>, он описывает то, как можно создать CE базу данных версии 4.0 на последней MS Management Studio (я даже удивился, что вот молодцы команда SQL Server, уже поддерживает новую версию CE), а ему потом намекнули о том, что работаешь то ты с 3.x версией, а не 4-ой. </p>  <p>Еще нашел блог <a href="http://erikej.blogspot.com/">Everything SQL Server Compact</a>, автор которого опубликовал свои утилиты для работы с CE версиями БД, вот недавно даже вышла <a href="http://visualstudiogallery.msdn.microsoft.com/0e313dfd-be80-4afb-b5e9-6e74d369f7a1/">2-я версия его утилиты</a> для VS2010, но как нормально работать с ней я так и не понял (как таблицу-то создать?). </p>  <p>В общем, ничего не оставалось, как ставить себе <a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=11ea69cb-cf12-4842-a3d7-b32a1e5642e2&amp;displaylang=en">Sevice Pack 1 Beta 1 на VS2010</a>, так как для него уже есть <a href="http://go.microsoft.com/fwlink/?LinkID=206994">SQL Compact Edition 4 Tools for VS2010 SP1 Beta</a>, с которым хоть как-то да можно поработать. Дизайнер там, конечно, такой, к которому нужно привыкнуть. Ограничений, с которыми я столкнулся много: <strong>а)</strong> нельзя изменять нормально таблицы с типом ntext (точно не помню, но такое ощущение, что даже удалить эту колонку нельзя или добавить, если есть записи); <strong>б)</strong> нельзя для существующей int колонки добавить свойства Identity(1,1), если существуют записи; <strong>в)</strong> в дизайнере запросов если написать SELECT TOP x, то он скажет что “<em>'TOP Clause' support not available in SqlCE.</em>”, но если нажать Continue, то запрос выполнится. В общем, есть небольшие проблемы, будем ждать инструмента для работы с SqlCE для Management Studio, там, вроде, все получше работает. Ну, а после установки всех инструментов, можно будет в Add –&gt; New Item… добавлять SQL Server Compact 4.0 Local Database:</p>  <p><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; border-top: 0px; margin-right: auto; border-right: 0px; padding-top: 0px" title="SQLServerCE" border="0" alt="SQLServerCE" src="/Library/2011/01/30/SQLServerCE_187EA7F6.png" width="855" height="450" /></p>  <p>У меня раньше использовался Linq2Sql совместно с Sql Server 2008 базой данных, мне нужно быстро было бы сменить репозитории, и вот с радостью узнал, что последний <a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=35adb688-f8a7-4d28-86b1-b6235385389d">Microsoft ADO.NET Entity Framework Feature Community Technology Preview 5</a> поддерживает работу с SQL Server CE 4.0. Потому переписывать особо не много нужно было, просто поменять DataContext. Самое удивительное, что разобраться, как создать ADO.NET Entity Data Model не так просто. Я, вроде, все поставил, иду в свою библиотеку PersonalWeb.Model, чтобы создать новый Data Model, и обнаруживаю, что в списке провайдеров нет SQL Server Compact 4.0, есть только 3.5 версия. Не поверите, но создать новый ADO.NET Entity Data Model с версией провайдера SQL Server Compact 4.0 можно только в веб-проекте. Потому идем в веб-проект и создаем Data Model именно там, где уже обнаружим необходимый Data Provider (спрашивается зачем так сделано? я полчаса потратил для того, чтобы это понять):</p>  <p><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; border-top: 0px; margin-right: auto; border-right: 0px; padding-top: 0px" title="DataSource" border="0" alt="DataSource" src="/Library/2011/01/30/DataSource_6900135C.png" width="515" height="294" /></p>  <p>Дальше нужен Membership провайдер (кому-то может еще и Role-,Profile- провайдеры). Я особо не переживал, если что написал бы сам, даже уже был готов написать сам провайдер, но вовремя обнаружил готовый <a href="http://sqlcemembership.codeplex.com/">http://sqlcemembership.codeplex.com/</a> (опять же написал человек, владелец блога <a href="http://erikej.blogspot.com/">Everything SQL Server Compact</a>, так что рекомендую). Поставил его, и он заработал. Единственное, у хостера пришлось поменять одну настройку для ASP.NET MVC 3, чтобы решить ошибку, которая возникала “This method cannot be called during the application's pre-start initialization stage.”, об этом я писал раньше <a href="/ru/blog/show/272">Обновляем приложение с MVC 2 до MVC 3</a>.&#160; </p>  <p>Ну и на последок: хранимые процедуры (некоторые запросы мне было сложно написать на Linq) я переделал на использование метода <a href="http://msdn.microsoft.com/en-us/library/dd487208.aspx">ExecuteStoreQuery&lt;TElement&gt;</a>.</p>  <p>В общем-то вот все и готово, вот так я и перевел проект на SQL Server CE 4, он у меня не большой конечно же, потому хватило с разбором полета, поиска утилит и т.п. в районе 4 часов.</p>  <h2>Публикуем сайт с SQL Server CE 4.0 к хостеру</h2>  <p>Очевидно, что вряд ли текущие хостеры поставили себе библиотеки SQL Server CE 4.0, но использовать эту версию БД все равно можно, нужно только предпринять немного действий. </p>  <p>Первое, нужно скопировать сами библиотеки, идем в папку </p>  <blockquote>   <p>c:\Program Files\Microsoft SQL Server Compact Edition\v4.0\Private\</p> </blockquote>  <p>Там все что есть копируем к хостеру в папку bin (со всеми подпапками):</p>  <p><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; border-top: 0px; margin-right: auto; border-right: 0px; padding-top: 0px" title="sqlcefolder" border="0" alt="sqlcefolder" src="/Library/2011/01/30/sqlcefolder_4878D3AA.png" width="745" height="300" /></p>  <p>Так же не забываем библиотеку System.Data.Entity.dll (так как мы поставили новую версию EF) - это в случае если тоже ее используете.</p>  <p>И последнее, нужно добавить Data Provider к хостеру в ваш web.config (в секцию configuration, как у меня):</p>  <pre><code>&lt;configuration&gt;
&#160;
    ...
&#160;    &lt;system.data&gt;
        &lt;DbProviderFactories&gt;
            &lt;remove invariant=&quot;System.Data.SqlServerCe.4.0&quot; /&gt; 
            &lt;add name=&quot;Microsoft SQL Server Compact Data Provider 4.0&quot; invariant=&quot;System.Data.SqlServerCe.4.0&quot; 
                description=&quot;.NET Framework Data Provider for Microsoft SQL Server Compact&quot; 
                type=&quot;System.Data.SqlServerCe.SqlCeProviderFactory, System.Data.SqlServerCe, Version=4.0.0.1, Culture=neutral, PublicKeyToken=89845dcd8080cc91&quot; /&gt; 
        &lt;/DbProviderFactories&gt;
    &lt;/system.data&gt;
&lt;/configuration&gt;
</code></pre>

<p>Вроде все.</p>

<p>Еще раз рекомендую ознакомиться с блогом <a href="http://erikej.blogspot.com/">Everything SQL Server Compact</a>, там действительно много информации по SQL Server CE.</p>

<p>Будут вопросы – спрашивайте, постараюсь помочь.</p>
