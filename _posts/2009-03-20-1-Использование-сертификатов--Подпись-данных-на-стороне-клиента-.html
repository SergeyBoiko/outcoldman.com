---
layout: post
title: "Использование сертификатов: Подпись данных на стороне клиента."
date: 2009-03-20 04:04:00
categories: ru
tags: [SSL, x509, ASP.NET, JavaScript, Certificate, Сертификаты]
permalink: ru/blog/show/1
---
<p>Одно из назначений для сертификата – это подписывание данных. Цель подписи может быть различной – валидация клиента или просто проверка достоверности данных. </p>

<p>Одна из задач, которая у вас может возникнуть – это подписать некоторые данные на стороне клиента в браузере пользователя. Такая задача может возникнуть тогда, когда пользователь подает некоторые важные данные, и для того, чтобы он в будущем не отказывался со словами «Это делал не я!» от этих данных. Для этого могут служить сертификаты. Подробнее о сертификатах и о SSL можно узнать где угодно, достаточно в поисковике набрать «SSL сертификаты» и информации об их назначении и о необходимости будет предостаточно. </p>

<p>Для реальных задач вам, скорее всего, понадобятся сертификаты удовлетворяющие алгоритмам ГОСТа, одна из программ реализующая их это КриптоПро, хотя даже вроде как и единственная. Но для того чтобы разрабатывать или тестировать сама программа вам не понадобится. Идея сертификатов так же в том, что пользователь и разработчик не должны вникать в то, какие алгоритмы они реализуют, какие типы ключей в них содержаться, и программа, работающая с сертификатами одного типа так же работала бы на сертификатах другого типа (это в теории, в практике может быть будут проблемы с некоторыми настройками контейнеров и вообще администрированием). Главное – для нашей задачи - это чтобы сертификат сервера и клиента соответствовали одному алгоритму. </p>

<p>Для тестирования мы можем воспользоваться Windows Server 2003 и его службой сертификации. Для этого необходимо при помощи мастера компонентов Windows установить службу сертификации, во время установки будут заданы некоторые вопросы, относительно имени сервера сертификации, срока его службы и остального. После установки мы будем иметь по адресу http://localhost/certsrv/ веб сайт, предоставляющий возможность запросить сертификат. А в администрировании в центре сертификации мы сможем подтверждать запросы на выдачу сертификатов. Если разрабатывать вы будете на Vista, либо Windows 7, тогда вам необходимо будет установить на Win2003 патч KB922706. </p>

<p>Другой способ создавать тестовые сертификаты при помощи программки makecert. Так же можно использовать и какие либо другие тестовые службы сертификации. У крипто про так же есть внешний тестовый сервер сертификации. </p>

<p>Первое что необходимо сделать – это установить сертификат ЦС на машину, на которой вы будете разрабатывать ваше приложение, чтобы она могла доверять этому центру выдачи и могла использовать сертификаты от этого центра. </p>

<p>Второе - это сгенерировать сертификат проверки сервера на эту машину. Имя сертификата должно совпадать с dns именем веб-приложения, но так как мы разрабатываем приложение локально, то для тестов мы возьмем имя localhost (хочу заметить, что если вы выдали сертификат на имя www.mydns.ru, то обратившись к mydns.ru вы увидите ошибку о том, что сертификат выдан не на это имя). Важно еще знать, что есть хранилище сертификатов пользователя, и отдельно хранилище сертификатов машины. По умолчанию, стандартно, сертификаты устанавливаются в хранилище пользователя, а для того чтобы сертификат проверки сервера использовать на сайте необходимо его положить в Local Computer/Personal. Посмотреть в каких местах какие сертификаты находятся можно следующим способом: запускаем Microsoft Management Console (вызывом mmc.exe) там нажимаем ctrl+m и выбираем snap-in Certificates (сначала пользователя, затем Local Computer) и там вы видим полное дерево сертификатов. </p>

<p><a href="/Library/Images/01/0000001.jpg"><img border="0" alt="" src="/Library/Images/01/0000001.jpg" width="640" height="370" /></a>  </p>

<p>Следующим действием нам нужно установить сертификат localhost на сайт. Открываем IIS и в зависимости от его версии настройки могут быть разные. В IIS 5.1 или 6.0 в окне свойств сайта нужно перейти на вкладку Security и там при помощи кнопки Security установить сертификат. В IIS 7 необходимо открыть свойства “Bindings…” и там добавить binding с типом https, в этом же окне необходимо будет выбрать сертификат (если сертификата в выпадающем списке нету, значит он лежит не в верной директории либо сертификат не с типом проверки подлинности сервера). </p>

<p><a href="/Library/Images/01/0000002.jpg"><img border="0" alt="" src="/Library/Images/01/0000002.jpg" width="640" height="324" /></a> </p>

<p>Теперь можем проверить, что наш веб-сайт откликается на https и может соединиться посредством SSL шифрования для этого набираем в браузере https://localhost/... (если не открывается – проверьте что установлен сертификат ЦС в Trusted Root Certification Authorities). </p>

<p>Установка сертификата на сайт дает нам доступ к сайту с шифрованием. Можно использовать при помощи настроек так же и двухстороннее шифрование, тогда каждый пользователь, заходящий на сайт по https пути должен будет указать и свой сертификат (настройка может быть «не указывать», «желателен», «необходим»). </p>

<p>Для того чтобы производить подписывание на клиенте данных необходимости в установке серверного сертификата нету, но вряд ли перед вами будет стоят задача подписи без установки зашифрованного соединения. </p>

<p>Теперь приступим к подписыванию данных. Создаем ASP.NET веб-сайт, на страничку Default.aspx кладем следующие контролы: </p>


<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;">
  <div id="codeSnippet" >
    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">&lt;!--сюда пишем данные,которые будем подписывать--&gt;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">asp:TextBox</span> <span style="color: #ff0000;">runat</span><span style="color: #0000ff;">=&quot;server&quot;</span> <span style="color: #ff0000;">ID</span><span style="color: #0000ff;">=&quot;tbDataText&quot;</span> <span style="color: #ff0000;">Width</span><span style="color: #0000ff;">=&quot;400px&quot;</span><span style="color: #0000ff;">/&gt;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">&lt;!--кнопка, которая выполняет функцию подписи данных--&gt;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">asp:Button</span> <span style="color: #ff0000;">runat</span><span style="color: #0000ff;">=&quot;server&quot;</span> <span style="color: #ff0000;">ID</span><span style="color: #0000ff;">=&quot;btnSignData&quot;</span> <span style="color: #ff0000;">Text</span><span style="color: #0000ff;">=&quot;Подписать данные&quot;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #ff0000;">OnClientClick</span><span style="color: #0000ff;">=&quot;if (SignData() == false) return false;&quot;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #ff0000;">onclick</span><span style="color: #0000ff;">=&quot;btnSignData_Click&quot;</span> <span style="color: #0000ff;">/&gt;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">&lt;!--сюда записываем данные--&gt;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">asp:TextBox</span> <span style="color: #ff0000;">runat</span><span style="color: #0000ff;">=&quot;server&quot;</span> <span style="color: #ff0000;">ID</span><span style="color: #0000ff;">=&quot;tbSignedData&quot;</span> <span style="color: #ff0000;">TextMode</span><span style="color: #0000ff;">=&quot;MultiLine&quot;</span> <span style="color: #ff0000;">Width</span><span style="color: #0000ff;">=&quot;600px&quot;</span> <span style="color: #ff0000;">Rows</span><span style="color: #0000ff;">=&quot;24&quot;</span> <span style="color: #0000ff;">/&gt;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">&lt;!--сюда выводим сообщения после подписи данных--&gt;</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">asp:Label</span> <span style="color: #ff0000;">runat</span><span style="color: #0000ff;">=&quot;server&quot;</span> <span style="color: #ff0000;">ID</span><span style="color: #0000ff;">=&quot;lblData&quot;</span> <span style="color: #0000ff;">/&gt;</span> </pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span> </pre>
<!--CRLF--></div>
</div>

<p>
  Кнопка btnSignData сначала вызывает javascript функцию SignData() со следующим кодом: 
</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;">
  <div id="codeSnippet" >
    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">function</span> SignData() {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// Необходимые константы </span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">var</span> CAPICOM_STORE_OPEN_READ_ONLY = 0;</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">var</span> CAPICOM_CURRENT_USER_STORE = 2;</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// проверяем, что поддерживаются ActiveXObject (Internet Explorer) </span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">if</span> (window.ActiveXObject) {</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">try</span> {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">// Подписываемые данные </span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">var</span> tbDataText = document.getElementById(<span style="color: #006080;">'&lt;%= tbDataText.ClientID %&gt;'</span>);</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">//Создаем необходимые объекты ActiveX </span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">var</span> CertStore = <span style="color: #0000ff;">new</span> ActiveXObject(<span style="color: #006080;">&quot;CAPICOM.Store&quot;</span>);</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">var</span> Signer = <span style="color: #0000ff;">new</span> ActiveXObject(<span style="color: #006080;">&quot;CAPICOM.Signer&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">var</span> SignedAuth = <span style="color: #0000ff;">new</span> ActiveXObject(<span style="color: #006080;">&quot;CAPICOM.SignedData&quot;</span>);</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">//Открываем хранилище сертификатов пользователя только для чтения </span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            CertStore.Open(CAPICOM_CURRENT_USER_STORE, <span style="color: #006080;">&quot;MY&quot;</span>, CAPICOM_STORE_OPEN_READ_ONLY);</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">//Выводим пользователю окно выбора сертификата </span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">try</span> {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                <span style="color: #0000ff;">var</span> certificate = CertStore.Certificates.Select(<span style="color: #006080;">&quot;Выберите сертификат для подписи документа.&quot;</span>, </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                        <span style="color: #006080;">&quot;Выберите один из сертификатов&quot;</span>, <span style="color: #0000ff;">false</span>);</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            }</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">catch</span> (e) {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                <span style="color: #008000;">// Пользователь не выбрал сертификат </span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span>;</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            }</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">//Подписываемые данные </span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            SignedAuth.Content = <span style="color: #006080;">&quot;Дата подписи: &quot;</span> + (<span style="color: #0000ff;">new</span> Date()) + <span style="color: #006080;">&quot;, Данные: &quot;</span> + tbDataText.value;</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">//Выбранный сертификат </span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            Signer.Certificate = certificate.Item(1);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">//Сюда запишем данные (можно писать в hidden поле, тут сделано для примера) </span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">var</span> lblData = document.getElementById(<span style="color: #006080;">'&lt;%= tbSignedData.ClientID %&gt;'</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #008000;">// Подписываем </span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            lblData.value = SignedAuth.Sign(Signer, <span style="color: #0000ff;">false</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        } <span style="color: #0000ff;">catch</span> (e) {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            alert(<span style="color: #006080;">'Невозможно подписать данные. Убедитесь что браузером разрешно использование ActiveX. '</span> </pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                + <span style="color: #006080;">' Добавьте сайт в Trusted Sites.'</span>);</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        }</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">else</span> {</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        alert(<span style="color: #006080;">'Используйте Internet Explorer для просмотра данного сайта'</span>);</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">} </pre>
<!--CRLF--></div>
</div>

<p>
  Данный скрипт как раз и подписывает данные на стороне клиента. Он работает только в IE, во время работы скрипта он может ругаться, требовать прав на запуск ActiveX объектов, самое простое добавить данный сайт в зону Trusted Sites. </p>

  <p>На стороне сервера можем выполнять следующий код при нажатии на кнопку: </p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;">
  <div id="codeSnippet" >
    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> btnSignData_Click(<span style="color: #0000ff;">object</span> sender, EventArgs e)</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    StringBuilder sb = <span style="color: #0000ff;">new</span> StringBuilder();</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// Смотрим, что подписано  </span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    SignedCms cms = <span style="color: #0000ff;">new</span> SignedCms();</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    cms.Decode(Convert.FromBase64String(tbSignedData.Text));</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// Проверяем подпись  </span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    cms.CheckSignature(<span style="color: #0000ff;">false</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">// Что подписано  </span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    sb.AppendLine(Encoding.Unicode.GetString(cms.ContentInfo.Content));</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #008000;">//Сравним сертификат, которым были подписаны данные, и клиентский сертификат   </span></pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">if</span> (Request.IsSecureConnection &amp;&amp; Request.ClientCertificate.IsPresent)</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        X509Certificate2 cert = <span style="color: #0000ff;">new</span> X509Certificate2(Request.ClientCertificate.Certificate);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">if</span> (cms.SignerInfos.Count &gt; 0 &amp;&amp; <span style="color: #0000ff;">string</span>.Compare(cms.SignerInfos[0].Certificate.SerialNumber, cert.SerialNumber) == 0</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            &amp;&amp; <span style="color: #0000ff;">string</span>.Compare(cms.SignerInfos[0].Certificate.Issuer, cert.Issuer) == 0)</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            sb.AppendLine(<span style="color: #006080;">&quot;&lt;br/&gt;Данные подписаны клиентским сертификатом&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        }</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">else</span></pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        {</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            sb.AppendLine(<span style="color: #006080;">&quot;&lt;br/&gt;Данные подписаны отличным от клиентского сертификатом&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        }</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre>
<!--CRLF-->

    <pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    lblData.Text = sb.ToString();</pre>
<!--CRLF-->

    <pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre>
<!--CRLF--></div>
</div>

<p>Для выполнения данного кода может потребоваться установить reference на библиотеку System.Security, включающую namespace System.Security.Cryptography. </p>

  <p>Таким способом вы сможете не просто хранить какие-либо данные, может быть важные вам, а к тому же и быть уверенным в их достоверности. Надеюсь, эта статья вам поможет в начальном изучении сертификатов. </p>

  <h4>Скачать пример: <a href="/Library/Content/01/CertificateWebExample.zip">CertificateWebExample.zip</a></h4>

