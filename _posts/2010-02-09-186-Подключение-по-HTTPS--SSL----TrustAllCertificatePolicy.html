---
layout: post
title: "Подключение по HTTPS (SSL) - TrustAllCertificatePolicy"
date: 2010-02-09 13:04:00
categories: ru
tags: [SSL, Certificate, .NET, C#, https]
permalink: ru/blog/show/186
---
<p>Когда подключаетесь по HTTPS (SSL) к веб-ресурсу – можно получить такую ошибку:</p>  <p><em>&quot;The underlying connection was closed: Could not establish trust relationship with remote server.&quot;</em></p> <lj-cut>  <p>Дело может быть в том, что сервер использует либо просроченный сертификат, либо какой-то самоизданный сертификат, сертификат УЦ которого не установлен на вашем компьютере, либо сертификат выдан на DNS имя, а подключаетесь вы по IP. В общем, причин может быть масса. Когда вы открываете веб-сайт через браузер – он вам предложит на выбор: открыть соединение или нет, программно так вам никто не сделает само собой. Проблему эту можно обойти при помощи свойства <a href="http://msdn.microsoft.com/en-us/library/system.net.servicepointmanager.certificatepolicy.aspx">ServicePointManager.CertificatePolicy</a> и интерфейса <a href="http://msdn.microsoft.com/en-us/library/system.net.icertificatepolicy.aspx">ICertificatePolicy</a>. Пишем свой Policy, очень простой:</p>  

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">using</span> System.Net; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">using</span> System.Security.Cryptography.X509Certificates; </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TrustAllCertificatePolicy : ICertificatePolicy </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{ </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">bool</span> CheckValidationResult(ServicePoint sp, </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        X509Certificate cert, WebRequest req, <span style="color: #0000ff;">int</span> problem) </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    { </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span>; </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    } </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">} </pre><!--CRLF--></div></div>

<p>Затем перед использованием веб-ресурсов выставляем это Policy по умолчанию:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">System.Net.ServicePointManager.CertificatePolicy = <span style="color: #0000ff;">new</span> TrustAllCertificatePolicy();</pre><!--CRLF--></div></div>

<p>
<a rev="vote-for" href="http://progg.ru/outcoldman-%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE-HTTPS-SSL-TrustAllCertificatePolicy"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.livejournal.com%2F49378.html" style="border:0px"/></a></p>
