---
layout: post
title: "NHibernate – auto mapper"
date: 2010-02-04 12:22:00
categories: ru
tags: [.NET, C#, XML, NHibernate, TDD, ORM, FluentNHibernate]
permalink: ru/blog/show/176
---
<p>В продолжение темы про NHibernate: <a href="http://xorets.livejournal.com/">xorets</a> сделал мне дельное замечание по поводу того, что неуместно наследоваться от класса Configuration без необходимости: а сделал я это не просто так, а потому что была у нас задача создавать маппинг наших объектов в NHibernate при помощи наших собственных методанных, а так как некоторые необходимые методы были protected в классе Configuration мне и пришлось от него унаследоваться (пример, кстати, я взял откуда то). Хотел вам рассказать как реализовать автоматический маппинг, но вспомнил про <a title="http://fluentnhibernate.org/" href="http://fluentnhibernate.org/">FluentnHibernate</a> и остановился. Это в нашем случае он не подходил, так как у нас были свои метаданные, а в обычном случае метаданными могут являться сами типы объектов и при помощи reflection можно получить достаточную информацию, чтобы замапить тип на таблицу, такое и предоставляет <a title="http://fluentnhibernate.org/" href="http://fluentnhibernate.org/">FluentnHibernate</a> - <a href="http://wiki.fluentnhibernate.org/Auto_mapping">Auto mapping</a>. Вообще, если вы все же столкнетесь с такой задачей, как автоматический маппинг из своих методанных – то рекомендую не терять время на разбор кода NHibernate, а делать следующее – создавать по методанным обычные xml маппинги NHibernate и их уже подсовывать конфигурации (Так собственно и работают Fluent и ActiveRecord, если я ничего не путаю). Синтаксис xml маппинга и все подводные камни уже хорошо везде описаны, потому я и считаю это лучшим способом.</p>   <p>В случае, если вы будете использовать FluentnHibernate для автоматического маппинга типов на таблицы, расскажу как это легко настраивается. </p>  <p>Берем класс User:</p> 

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">namespace</span> FluentnHibernateTest.Domain</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> User</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">int</span> Id { get; <span style="color: #0000ff;">private</span> set; }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">string</span> Name { get; set; }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">virtual</span> <span style="color: #0000ff;">string</span> Surname { get; set; }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>Создаем для него таблицу в БД:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">CREATE</span> <span style="color: #0000ff;">TABLE</span> [<span style="color: #0000ff;">User</span>](</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    [Id] [<span style="color: #0000ff;">int</span>] <span style="color: #0000ff;">IDENTITY</span>(1,1) <span style="color: #0000ff;">NOT</span> <span style="color: #0000ff;">NULL</span> <span style="color: #0000ff;">PRIMARY</span> <span style="color: #0000ff;">KEY</span>,</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    [Name] [<span style="color: #0000ff;">varchar</span>](50) <span style="color: #0000ff;">NOT</span> <span style="color: #0000ff;">NULL</span>,</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    [Surname] [<span style="color: #0000ff;">varchar</span>](50) <span style="color: #0000ff;">NOT</span> <span style="color: #0000ff;">NULL</span></pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> )</pre><!--CRLF--></div></div>

<p>И последний рывок, пишем один класс – тест:</p>

<div id="codeSnippetWrapper" style="background-color: #f4f4f4;color: black;font-family: 'Courier New', Courier, Monospace;	font-size: 9pt; line-height: 12pt; border: solid 1px silver; cursor: text; margin: 20px 0px 10px 0px; overflow: auto; padding: 4px; width: 97.5%; direction: ltr; text-align: left;"><div id="codeSnippet" >
<pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">[TestFixture]</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FluentTest</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">{</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">private</span> ISessionFactory _sessionFactory;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">private</span> FluentConfiguration _configuration;</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    [TestFixtureSetUp]</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> SetUp()</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        _configuration = Fluently.Configure()</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            .Database(MsSqlConfiguration.MsSql2008.ConnectionString(<span style="color: #006080;">"user id=XXX; password=XXX; server=(local); database=XXX;"</span>))</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">            .Mappings(m =&gt; m.AutoMappings</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">                          .Add(AutoMap.AssemblyOf&lt;User&gt;().Where(t =&gt; t.Namespace == <span style="color: #006080;">"FluentnHibernateTest.Domain"</span>)));</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">        _sessionFactory = _configuration.BuildSessionFactory();</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    [Test]</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> TestData()</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #0000ff;">using</span> (ISession session =  _sessionFactory.OpenSession())</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">           User user = <span style="color: #0000ff;">new</span> User { Name = <span style="color: #006080;">"User1_Name"</span>, Surname = <span style="color: #006080;">"User1_Surname"</span>};</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">           session.Save(user);</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">           session.Flush();</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       IList&lt;User&gt; users;</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #0000ff;">using</span> (ISession session = _sessionFactory.OpenSession())</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">           users = session.CreateCriteria&lt;User&gt;()</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">               .Add(Restrictions.Eq(<span style="color: #006080;">"Name"</span>, <span style="color: #006080;">"User1_Name"</span>))</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">               .List&lt;User&gt;();</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> </pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       Assert.AreEqual(users.Count, 1);</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       Assert.AreEqual(users[0].Surname, <span style="color: #006080;">"User1_Surname"</span>);</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;"> </pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       <span style="color: #0000ff;">using</span> (ISession session = _sessionFactory.OpenSession())</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       {</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">           session.Delete(users[0]);</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">           session.Flush();</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">       }</pre><!--CRLF--><pre style="border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">    }</pre><!--CRLF--><pre style="background-color: white;border-style: none; overflow: visible; padding: 0px; width: 100%; margin: 0em;">}</pre><!--CRLF--></div></div>

<p>Как видно из кода я в методе SetUp законфигурировал NHibernate при помощи Fluently, указав просто, чтобы собралась информация по всем классам в сборке, в которой лежит тип User, и которые лежат в пространстве имен FluentnHibernateTest.Domain. Дальше код для тестирования работы самого ORM – он действительно работает :) Хотя конечно не так все гладко, за 10 секунд я не понял как сделать каскадное сохранение объектов, может такие случаи нужно самому добавлять? Не знаю… </p>

<p>В общем, напрашивается вывод. Если вы пишите приложение, на первом этапе которого уж очень простая логика, но есть опаска, что логика будет разрастаться, то наш вариант FluentnHibernate. При помощи которого изначально мы создадим автоматический маппинг, а дальше по мере необходимости будем его подпиливать. Интересно, живут ли такие проекты в настоящей жизни? </p>

<p><b>UPDATE:</b> Вариантов автоматического маппинга много, иногда хватает и такого: <a href="http://weblogs.asp.net/srkirkland/archive/2010/02/03/simple-sql-server-script-for-generating-nhibernate-classes-mappings.aspx">Simple SQL Server Script For Generating NHibernate Classes/Mappings</a></p>
<p>

<a rev="vote-for" href="http://progg.ru/outcoldman-NHibernate-auto-mapper"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Foutcoldman.livejournal.com%2F48014.html" style="border:0px"/></a></p>
