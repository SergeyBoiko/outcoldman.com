---
layout: post
title: "TSQL: Passing array/list/set to stored procedure (MS SQL Server)"
date: 2010-08-28 09:18:00
categories: en
tags: [.NET, TSQL, SQL Server, Transact SQL, Bulk Insert, Table-Valued Parameters, Stored Procedures]
permalink: en/blog/show/224
---
<p>Passing array/list/set to stored procedure is fairly common task when you are working with Databases. You can meet this when you want to filter some collection. Other case – it can be an import into database from extern sources. I will consider few solutions: creation of sql-query at server code, put set of parameters to sql stored procedure’s parameter with next variants: parameters separated by comma, bulk insert, and at last table-valued parameters (it is most interesting approach, which we can use from MS SQL Server 2008).</p>

<p>Ok, let’s suppose that we have list of items and we need to filter this items by categories (“TV”, “TV game device”, “DVD-player”) and by firms (“Firm 1”, “Firm2”, “Firm 3). It will look at database like this</p>

<p><img src="/library/images/02/tableparameters/01.png" /></p>

<p>And I will show you sample of this interface</p>

<p>

<div style="border-bottom: gray 2px solid; border-left: gray 2px solid; padding-bottom: 5px; padding-left: 5px; padding-right: 5px; border-top: gray 2px solid; border-right: gray 2px solid; padding-top: 5px">
  <fieldset>
    <legend>Filter</legend>

	<div style="width:600px;height:170px">
    <div style="float: left; width: 300px"><b>Categories</b> 

      <ul>
        <li><input type="checkbox" />TV</li>

        <li><input type="checkbox" />Games</li>

        <li><input type="checkbox" />DVD</li>

        <li><input type="checkbox" />CD</li>

        <li><input type="checkbox" />Players</li>
      </ul>
    </div>

    <div style="float: left; width: 300px"><b>Firms</b> 

      <ul>
        <li><input type="checkbox" />Firm 1 </li>

        <li><input type="checkbox" />Firm 2 </li>

        <li><input type="checkbox" />Firm 3 </li>

        <li><input type="checkbox" />Firm 4 </li>

        <li><input type="checkbox" />Firm 5 </li>
      </ul>
    </div>
	</div>
	
     <input type="button" value="Search" style="float:right" /><input type="button" value="Clear" style="float:right" /> 
	
</fieldset>

  <fieldset >
    <legend>Items</legend>

    <table style="border:gray solid 1px; width:600px"><tbody>
        <tr>
          <th>Item</th>

          <th>Category</th>

          <th>Firm</th>
        </tr>

        <tr>
          <td>TV 32'</td>

          <td>TV</td>

          <td>Firm 1</td>
        </tr>

        <tr>
          <td>XBox 360</td>

          <td>Games</td>

          <td>Firm 3</td>
        </tr>
     </tbody></table>
  </fieldset>
</div>
</p>

<p>So we need a query which will return us list of items from database. Also we need opportunity to filter these items by categories or by firms. We will filter them by identifiers. Ok, we know the mission. How we will solve it? Most easy way, used by junior developers – it is creating SQL-instruction with C# code, it can be like this </p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em">List&lt;<span style="color: #0000ff">int</span>&gt; categories = <span style="color: #0000ff">new</span> List&lt;<span style="color: #0000ff">int</span>&gt;() { 1, 2, 3 };</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">StringBuilder sbSql = <span style="color: #0000ff">new</span> StringBuilder();</pre>
<!--CRLF-->

    <pre style="margin: 0em">sbSql.Append(</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  <span style="color: #006080">@&quot;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    select i.Name as ItemName, f.Name as FirmName, c.Name as CategoryName </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    from Item i</pre>
<!--CRLF-->

    <pre style="margin: 0em">      inner join Firm f on i.FirmId = f.FirmId</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">      inner join Category c on i.CategoryId = c.CategoryId</pre>
<!--CRLF-->

    <pre style="margin: 0em">    where c.CategoryId in (&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">if</span> (categories.Count &gt; 0)</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  <span style="color: #0000ff">for</span> (<span style="color: #0000ff">int</span> i = 0; i &lt; categories.Count; i ++)</pre>
<!--CRLF-->

    <pre style="margin: 0em">  {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> (i != 0)</pre>
<!--CRLF-->

    <pre style="margin: 0em">      sbSql.Append(<span style="color: #006080">&quot;,&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    sbSql.Append(categories[i]);</pre>
<!--CRLF-->

    <pre style="margin: 0em">  }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">else</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">  sbSql.Append(<span style="color: #006080">&quot;-1&quot;</span>); <span style="color: #008000">// It is for empty result when no one category selected</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">sbSql.Append(<span style="color: #006080">&quot;)&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">string</span> sqlQuery = sbSql.ToString();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">DataTable table = <span style="color: #0000ff">new</span> DataTable();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">using</span> (SqlConnection connection = <span style="color: #0000ff">new</span> SqlConnection(<span style="color: #006080">&quot;Data Source=(local);Initial Catalog=TableParameters;Integrated Security=SSPI;&quot;</span>))</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  connection.Open();</pre>
<!--CRLF-->

    <pre style="margin: 0em">  <span style="color: #0000ff">using</span> (SqlCommand command = <span style="color: #0000ff">new</span> SqlCommand(sqlQuery, connection))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  {</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">using</span> (SqlDataAdapter dataAdapter = <span style="color: #0000ff">new</span> SqlDataAdapter(command))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">      dataAdapter.Fill(table);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">  }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #008000">//TODO: Working with table</span></pre>
<!--CRLF--></div>
</div>

<p>We will filter items only by categories. Just want to write less code. In the previous example first line is list of categories identifiers, chosen by user (user can select checkboxes). Problems of this solution are: a) sql-injections in some cases (user can change identifiers, which we get from web-form); b) not really good code support at feature when categories can be a really big set. One more problem – it will be hard to place this code to stored procedure (of course you can use exec statement at sql-server, but it will be not a good choice). So we can name this solution like “Solution #0”, because you can use it only if you are very lazy guy, or because this solution is very fast written. </p>

<h2>Solution #1. String – parameters separated by comma. </h2>

<p>In all next solutions we will use stored procedures at sql server. So first solution will be a list of parameters separated by comma in one string sql-parameter, like this ‘1,2,3,4’. First we need to create function at sql server, which create a table from this string parameter, name of this function will be Split:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-left: 0px; padding-right: 0px; padding-top: 0px; adding-bottom: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">if</span> object_id(<span style="color: #006080">'Split'</span>) <span style="color: #0000ff">is</span> <span style="color: #0000ff">not</span> <span style="color: #0000ff">null</span> </pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">drop</span> <span style="color: #0000ff">function</span> split</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"> </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">create</span> <span style="color: #0000ff">function</span> dbo.Split</pre>
<!--CRLF-->

    <pre style="margin: 0em">(</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    @String <span style="color: #0000ff">varchar</span>(<span style="color: #0000ff">max</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">returns</span> @SplittedValues <span style="color: #0000ff">table</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">(</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    Id <span style="color: #0000ff">varchar</span>(50) <span style="color: #0000ff">primary</span> <span style="color: #0000ff">key</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">as</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">begin</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">declare</span> @SplitLength <span style="color: #0000ff">int</span>, @Delimiter <span style="color: #0000ff">varchar</span>(5)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">set</span> @Delimiter = <span style="color: #006080">','</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">while</span> len(@String) &gt; 0</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">begin</span> </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">select</span> @SplitLength = (<span style="color: #0000ff">case</span> charindex(@Delimiter,@String) <span style="color: #0000ff">when</span> 0 <span style="color: #0000ff">then</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">            len(@String) <span style="color: #0000ff">else</span> charindex(@Delimiter,@String) -1 <span style="color: #0000ff">end</span>)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"> </pre>
<!--CRLF-->

    <pre style="margin: 0em">        insert <span style="color: #0000ff">into</span> @SplittedValues</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">select</span> <span style="color: #0000ff">substring</span>(@String,1,@SplitLength) </pre>
<!--CRLF-->

    <pre style="margin: 0em">    </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">select</span> @String = (<span style="color: #0000ff">case</span> (len(@String) - @SplitLength) <span style="color: #0000ff">when</span> 0 <span style="color: #0000ff">then</span>  <span style="color: #006080">''</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">            <span style="color: #0000ff">else</span> <span style="color: #0000ff">right</span>(@String, len(@String) - @SplitLength - 1) <span style="color: #0000ff">end</span>)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">end</span> </pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">return</span>  </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">end</pre>
<!--CRLF--></div>
</div>

<p>Now we can use this function in our stored procedure for looking items:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">if</span> object_id(<span style="color: #006080">'FindItems'</span>) <span style="color: #0000ff">is</span> <span style="color: #0000ff">not</span> <span style="color: #0000ff">null</span> </pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">drop</span> <span style="color: #0000ff">proc</span> FindItems</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">set</span> ansi_nulls <span style="color: #0000ff">on</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">go</span> </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">set</span> quoted_identifier <span style="color: #0000ff">on</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">create</span> <span style="color: #0000ff">proc</span> FindItems</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">(</pre>
<!--CRLF-->

    <pre style="margin: 0em">    @categories <span style="color: #0000ff">varchar</span>(<span style="color: #0000ff">max</span>)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">)</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">as</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">begin</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  <span style="color: #0000ff">select</span> i.Name <span style="color: #0000ff">as</span> ItemName, f.Name <span style="color: #0000ff">as</span> FirmName, c.Name <span style="color: #0000ff">as</span> CategoryName </pre>
<!--CRLF-->

    <pre style="margin: 0em">  <span style="color: #0000ff">from</span> Item i</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> Firm f <span style="color: #0000ff">on</span> i.FirmId = f.FirmId</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> Category c <span style="color: #0000ff">on</span> i.CategoryId = c.CategoryId</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> dbo.Split(@categories) cf <span style="color: #0000ff">on</span> c.CategoryId = cf.Id</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">end</span> </pre>
<!--CRLF--></div>
</div>

<p>At last C# code, which will put filter to stored procedure and get list of products:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em">List&lt;<span style="color: #0000ff">int</span>&gt; categories = <span style="color: #0000ff">new</span> List&lt;<span style="color: #0000ff">int</span>&gt;() { 1, 2, 3 };</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">DataTable <span style="color: #0000ff">table</span> = <span style="color: #0000ff">new</span> DataTable();</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">using</span> (SqlConnection <span style="color: #0000ff">connection</span> = <span style="color: #0000ff">new</span> SqlConnection(&quot;<span style="color: #0000ff">Data</span> Source=(<span style="color: #0000ff">local</span>);Initial <span style="color: #0000ff">Catalog</span>=TableParameters;Integrated Security=SSPI;&quot;))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">  <span style="color: #0000ff">connection</span>.<span style="color: #0000ff">Open</span>();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  <span style="color: #0000ff">using</span> (SqlCommand command = <span style="color: #0000ff">new</span> SqlCommand(&quot;FindItems&quot;, <span style="color: #0000ff">connection</span>) { CommandType = CommandType.StoredProcedure })</pre>
<!--CRLF-->

    <pre style="margin: 0em">  {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    command.<span style="color: #0000ff">Parameters</span>.AddWithValue(&quot;@categories&quot;, string.<span style="color: #0000ff">Join</span>(&quot;,&quot;, categories));</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">using</span> (SqlDataAdapter dataAdapter = <span style="color: #0000ff">new</span> SqlDataAdapter(command))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">      dataAdapter.Fill(<span style="color: #0000ff">table</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">  }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">//TODO: Working <span style="color: #0000ff">with</span> table</pre>
<!--CRLF--></div>
</div>


<p>Problems of this solution can be: composite primary keys, or string identifiers with commas. But in simple cases it can works. </p>

<p>These problems you can solve with another solution “<a href="http://weblogs.asp.net/jgalloway/archive/2007/02/16/passing-lists-to-sql-server-2005-with-xml-parameters.aspx">Passing lists to SQL Server with XML Parameters</a>”, I don’t consider this solution in my article, because you can get a more great explanation of how to do it, because I never use this solution in my developer’s life. </p>

<h2>Solution #2. BULK INSERT</h2>

<p>Problems which we had at previous solution we can solve with Bulk Insert solution. We will have a code which will copy .Net DataTable object to SQL Server temporary table. First let rewrite our stored procedure FindItems:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">if</span> object_id(<span style="color: #006080">'FindItems'</span>) <span style="color: #0000ff">is</span> <span style="color: #0000ff">not</span> <span style="color: #0000ff">null</span> </pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">drop</span> <span style="color: #0000ff">proc</span> FindItems</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">set</span> ansi_nulls <span style="color: #0000ff">on</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">go</span> </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">set</span> quoted_identifier <span style="color: #0000ff">on</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">create</span> <span style="color: #0000ff">proc</span> FindItems</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">as</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">begin</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">if</span> object_id(<span style="color: #006080">'tempdb..#FilterCategory'</span>) <span style="color: #0000ff">is</span> <span style="color: #0000ff">null</span> </pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">begin</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">raiserror</span>(<span style="color: #006080">'#FilterCategory(id int) should be created'</span>, 16, 1)</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">return</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">end</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">select</span> i.Name <span style="color: #0000ff">as</span> ItemName, f.Name <span style="color: #0000ff">as</span> FirmName, c.Name <span style="color: #0000ff">as</span> CategoryName </pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">from</span> Item i</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> Firm f <span style="color: #0000ff">on</span> i.FirmId = f.FirmId</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> Category c <span style="color: #0000ff">on</span> i.CategoryId = c.CategoryId</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> #FilterCategory cf <span style="color: #0000ff">on</span> c.CategoryId = cf.Id</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">end</span> </pre>
<!--CRLF--></div>
</div>

<p>Now our procedure expects temporary table #FilterCategory, which you should create before using this SP. And now we should write more C# code than at previous time, we will create new repository class ItemsRepository:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> ItemsRepository</pre>
<!--CRLF-->

    <pre style="margin: 0em">{</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> DataTable FindItems(List&lt;<span style="color: #0000ff">int</span>&gt; categories)</pre>
<!--CRLF-->

    <pre style="margin: 0em">  {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    DataTable tbCategories = <span style="color: #0000ff">new</span> DataTable(<span style="color: #006080">&quot;FilterCategory&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    tbCategories.Columns.Add(<span style="color: #006080">&quot;Id&quot;</span>, <span style="color: #0000ff">typeof</span> (<span style="color: #0000ff">int</span>));</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    categories.ForEach(x =&gt; tbCategories.Rows.Add(x));</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">using</span> (</pre>
<!--CRLF-->

    <pre style="margin: 0em">      SqlConnection connection =</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">new</span> SqlConnection(<span style="color: #006080">&quot;Data Source=(local);Initial Catalog=TableParameters;Integrated Security=SSPI;&quot;</span>))</pre>
<!--CRLF-->

    <pre style="margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">      connection.Open();</pre>
<!--CRLF-->

    <pre style="margin: 0em">      <span style="color: #0000ff">using</span> (SqlTransaction transaction = connection.BeginTransaction())</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">      {</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">try</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="margin: 0em">          <span style="color: #0000ff">string</span> tableName = <span style="color: #0000ff">string</span>.Format(<span style="color: #006080">&quot;tempdb..#{0}&quot;</span>, tbCategories.TableName);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">          CreateTableOnSqlServer(connection, transaction, tbCategories, tableName);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">          CopyDataToSqlServer(connection, transaction, tbCategories, tableName);</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">          DataTable result = <span style="color: #0000ff">new</span> DataTable();</pre>
<!--CRLF-->

    <pre style="margin: 0em">          <span style="color: #0000ff">using</span> (SqlCommand command = <span style="color: #0000ff">new</span> SqlCommand(<span style="color: #006080">&quot;FindItems&quot;</span>, connection, transaction)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                        {CommandType = CommandType.StoredProcedure})</pre>
<!--CRLF-->

    <pre style="margin: 0em">          {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">            <span style="color: #0000ff">using</span> (SqlDataAdapter dataAdapter = <span style="color: #0000ff">new</span> SqlDataAdapter(command))</pre>
<!--CRLF-->

    <pre style="margin: 0em">            {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">              dataAdapter.Fill(result);</pre>
<!--CRLF-->

    <pre style="margin: 0em">            }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">          }</pre>
<!--CRLF-->

    <pre style="margin: 0em">          transaction.Commit();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">          <span style="color: #0000ff">return</span> result;</pre>
<!--CRLF-->

    <pre style="margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">catch</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">        {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">          transaction.Rollback();</pre>
<!--CRLF-->

    <pre style="margin: 0em">          <span style="color: #0000ff">throw</span>;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        }</pre>
<!--CRLF-->

    <pre style="margin: 0em">      }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">  }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">  <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> CopyDataToSqlServer(SqlConnection connection, SqlTransaction transaction, DataTable table,</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                          <span style="color: #0000ff">string</span> tableName)</pre>
<!--CRLF-->

    <pre style="margin: 0em">  {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">using</span> (SqlBulkCopy bulkCopy = <span style="color: #0000ff">new</span> SqlBulkCopy(connection, SqlBulkCopyOptions.Default, transaction)</pre>
<!--CRLF-->

    <pre style="margin: 0em">                                    {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                      DestinationTableName = tableName</pre>
<!--CRLF-->

    <pre style="margin: 0em">                                    })</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">      bulkCopy.WriteToServer(table);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">  }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">  <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> CreateTableOnSqlServer(SqlConnection connection, SqlTransaction transaction, DataTable table,</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                                             <span style="color: #0000ff">string</span> tableName)</pre>
<!--CRLF-->

    <pre style="margin: 0em">  {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    StringBuilder sb = <span style="color: #0000ff">new</span> StringBuilder();</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    sb.AppendFormat(<span style="color: #006080">&quot;create table {0}(&quot;</span>, tableName);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">foreach</span> (DataColumn column <span style="color: #0000ff">in</span> table.Columns)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">      sb.AppendFormat(<span style="color: #006080">&quot;{0} {1} {2}&quot;</span>,</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">                      table.Columns.IndexOf(column) == 0 ? <span style="color: #0000ff">string</span>.Empty : <span style="color: #006080">&quot;,&quot;</span>,</pre>
<!--CRLF-->

    <pre style="margin: 0em">                      column.ColumnName, GetSqlType(column.DataType));</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">    sb.Append(<span style="color: #006080">&quot;)&quot;</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">using</span> (SqlCommand command = <span style="color: #0000ff">new</span> SqlCommand(sb.ToString(), connection, transaction))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">      command.ExecuteNonQuery();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">  }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em">  <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">string</span> GetSqlType(Type type)</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  {</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span> (<span style="color: #0000ff">string</span>))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">      <span style="color: #0000ff">return</span> <span style="color: #0000ff">string</span>.Format(<span style="color: #006080">&quot;{0}(max)&quot;</span>, SqlDbType.VarChar);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span> (<span style="color: #0000ff">int</span>))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">      <span style="color: #0000ff">return</span> SqlDbType.Int.ToString();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span> (<span style="color: #0000ff">bool</span>))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">      <span style="color: #0000ff">return</span> SqlDbType.Bit.ToString();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span> (DateTime))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">      <span style="color: #0000ff">return</span> SqlDbType.DateTime.ToString();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (type == <span style="color: #0000ff">typeof</span> (Single))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">      <span style="color: #0000ff">return</span> SqlDbType.Float.ToString();</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">else</span> <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> NotImplementedException();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  }</pre>
<!--CRLF-->

    <pre style="margin: 0em">}</pre>
<!--CRLF--></div>
</div>


<p>Method FindItems create new object of type DataTable, copy to this object list of identifiers (chosen by user), then method open new transaction, create on SQL server new temporary table #FilterCategories, copy DataTable to server in this temporary table and then call stored procedure FindItems. This temporary table will be live only in transaction scope, so when we will commit or rollback transaction this table will be dropped too, and if two user in same time will execute this code, each of them will have separate temporary table #FilterCategories. </p>

<p>I used this solution very often when I had a task – copy data from Excel file to SQL server or some other import data task.</p>

<p>Let find minuses of this solution: a lot of code – is not a problem, because we can refactor this code and put it in some application framework. Next minus is more than one query for this task. Other – if this stored procedure will execute some other, which will create new temporary table with same name we will have a problems (it can be some recursive call). Other minus – will be hard to work with this approach from Management Studio, we need always write a script for creating temporary table (and the main problem you need to remember which structure this table has):</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">create</span> <span style="color: #0000ff">table</span> #FilterCategory(id <span style="color: #0000ff">int</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">insert <span style="color: #0000ff">into</span> #FilterCategory ( id ) <span style="color: #0000ff">values</span>  ( 1  )</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">insert <span style="color: #0000ff">into</span> #FilterCategory ( id ) <span style="color: #0000ff">values</span>  ( 2 )</pre>
<!--CRLF-->

    <pre style="margin: 0em">insert <span style="color: #0000ff">into</span> #FilterCategory ( id ) <span style="color: #0000ff">values</span>  ( 3  )</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">insert <span style="color: #0000ff">into</span> #FilterCategory ( id ) <span style="color: #0000ff">values</span>  ( 4  )</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">exec</span> FindItems</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">drop</span> <span style="color: #0000ff">table</span>  #FilterCategory</pre>
<!--CRLF--></div>
</div>

<h2>Solution #3. Table-Valued Parameters (Database Engine)</h2>

<p>And the last solution which I want to show you – is the table-valued parameters. This approach is very similar to previous, but more simple. You can use it in MS SQL server with version 2008 or bigger. Ok, we need again rewrite out stored procedure FindItems, and we should create new table-valued type Identifiers:</p>


<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">if</span> object_id(<span style="color: #006080">'FindItems'</span>) <span style="color: #0000ff">is</span> <span style="color: #0000ff">not</span> <span style="color: #0000ff">null</span> </pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">drop</span> <span style="color: #0000ff">proc</span> FindItems</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">if</span> <span style="color: #0000ff">exists</span>(<span style="color: #0000ff">select</span> * <span style="color: #0000ff">from</span> sys.types <span style="color: #0000ff">where</span> name = <span style="color: #006080">'Identifiers'</span>)</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">drop</span> type Identifiers</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">create</span> type Identifiers <span style="color: #0000ff">AS</span> <span style="color: #0000ff">TABLE</span> </pre>
<!--CRLF-->

    <pre style="margin: 0em">( id <span style="color: #0000ff">int</span> <span style="color: #0000ff">primary</span> <span style="color: #0000ff">key</span>);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">set</span> ansi_nulls <span style="color: #0000ff">on</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">go</span> </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">set</span> quoted_identifier <span style="color: #0000ff">on</span></pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">create</span> <span style="color: #0000ff">proc</span> FindItems</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">(</pre>
<!--CRLF-->

    <pre style="margin: 0em">    @categories Identifiers readonly</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">)</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">as</span></pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">begin</span></pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">select</span> i.Name <span style="color: #0000ff">as</span> ItemName, f.Name <span style="color: #0000ff">as</span> FirmName, c.Name <span style="color: #0000ff">as</span> CategoryName </pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    <span style="color: #0000ff">from</span> Item i</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> Firm f <span style="color: #0000ff">on</span> i.FirmId = f.FirmId</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">        <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> Category c <span style="color: #0000ff">on</span> i.CategoryId = c.CategoryId</pre>
<!--CRLF-->

    <pre style="margin: 0em">        <span style="color: #0000ff">inner</span> <span style="color: #0000ff">join</span> @categories cf <span style="color: #0000ff">on</span> c.CategoryId = cf.Id</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">end</span> </pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">go</span></pre>
<!--CRLF--></div>
</div>

<p>Also we need to rewrite C# code</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em">List&lt;<span style="color: #0000ff">int</span>&gt; categories = <span style="color: #0000ff">new</span> List&lt;<span style="color: #0000ff">int</span>&gt;() { 1, 2, 3 };</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">DataTable tbCategories = <span style="color: #0000ff">new</span> DataTable(<span style="color: #006080">&quot;FilterCategory&quot;</span>);</pre>
<!--CRLF-->

    <pre style="margin: 0em">tbCategories.Columns.Add(<span style="color: #006080">&quot;Id&quot;</span>, <span style="color: #0000ff">typeof</span>(<span style="color: #0000ff">int</span>));</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">categories.ForEach(x =&gt; tbCategories.Rows.Add(x));</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">DataTable table = <span style="color: #0000ff">new</span> DataTable();</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">using</span> (SqlConnection connection = <span style="color: #0000ff">new</span> SqlConnection(<span style="color: #006080">&quot;Data Source=(local);Initial Catalog=TableParameters;Integrated Security=SSPI;&quot;</span>))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">{</pre>
<!--CRLF-->

    <pre style="margin: 0em">  connection.Open();</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">  <span style="color: #0000ff">using</span> (SqlCommand command = <span style="color: #0000ff">new</span> SqlCommand(<span style="color: #006080">&quot;FindItems&quot;</span>, connection) { CommandType = CommandType.StoredProcedure })</pre>
<!--CRLF-->

    <pre style="margin: 0em">  {</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    command.Parameters.AddWithValue(<span style="color: #006080">&quot;@categories&quot;</span>, tbCategories);</pre>
<!--CRLF-->

    <pre style="margin: 0em">    <span style="color: #0000ff">using</span> (SqlDataAdapter dataAdapter = <span style="color: #0000ff">new</span> SqlDataAdapter(command))</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    {</pre>
<!--CRLF-->

    <pre style="margin: 0em">      dataAdapter.Fill(table);</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">    }</pre>
<!--CRLF-->

    <pre style="margin: 0em">  }</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">}</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF--></div>
</div>

<p>Now it is very easy, and it is easier to work with this stored procedure from Management Studio:</p>

<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: &#39;Courier New&#39;, courier, monospace; direction: ltr; color: black; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
  <div style="padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" id="codeSnippet">
    <pre style="background-color: white; margin: 0em"><span style="color: #0000ff">declare</span> @categories Identifiers</pre>
<!--CRLF-->

    <pre style="margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">insert <span style="color: #0000ff">into</span> @categories ( id ) <span style="color: #0000ff">values</span>  ( 1  )</pre>
<!--CRLF-->

    <pre style="margin: 0em">insert <span style="color: #0000ff">into</span> @categories ( id ) <span style="color: #0000ff">values</span>  ( 2 )</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">insert <span style="color: #0000ff">into</span> @categories ( id ) <span style="color: #0000ff">values</span>  ( 3  )</pre>
<!--CRLF-->

    <pre style="margin: 0em">insert <span style="color: #0000ff">into</span> @categories ( id ) <span style="color: #0000ff">values</span>  ( 4  )</pre>
<!--CRLF-->

    <pre style="background-color: white; margin: 0em">&#160;</pre>
<!--CRLF-->

    <pre style="margin: 0em"><span style="color: #0000ff">exec</span> FindItems @categories</pre>
<!--CRLF--></div>
</div>

<p>Table-valued parameters solution has some limitations, like this parameter should be always read-only. If you want to know about performance of this solution you can look at this article <a href="http://msdn.microsoft.com/en-us/library/bb510489.aspx">Table-Valued Parameters (Database Engine),</a> also this article will show you when will be better to use Bulk Insert and when Table-valued parameters. </p>
